<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Module Duy·ªát B√°o C√°o - Tr∆∞·ªüng Nh√≥m</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#5aa9ff',
            'muted': '#f8fafc',
            'ink': '#0b1324'
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    .spinner{border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;display:inline-block;vertical-align:middle}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .header-container{background:linear-gradient(135deg,#2563eb 0%,#60a5fa 100%);position:relative;overflow:hidden}
    .header-container::before{content:"";position:absolute;inset:0;background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ffffff' fill-opacity='0.08' fill-rule='evenodd'/%3E%3C/svg%3E");opacity:.4}
    .modal{position:fixed;inset:0;background:rgba(15,23,42,0.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:1000}
    .modal.open{display:flex}
    .toast{position:fixed;right:16px;bottom:16px;background:#0b1324;color:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.15);opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .table-zebra tbody tr:nth-child(even){ background-color:#f8fafc; }
    .table-vdiv{ border-collapse: separate; border-spacing: 0; }
    .table-vdiv th+th, .table-vdiv td+td{ border-left:1px solid #e5e7eb; }
    .submit-btn{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);box-shadow:0 4px 6px rgba(37,99,235,.1),0 1px 3px rgba(37,99,235,.08);transition:transform .2s ease,box-shadow .2s ease,opacity .2s ease,filter .2s ease;border-radius:9999px;position:relative}
    .submit-btn:hover{transform:translateY(-1px);box-shadow:0 7px 14px rgba(37,99,235,.12),0 3px 6px rgba(37,99,235,.08);filter:brightness(1.03)}
    .submit-btn:active{transform:translateY(0);opacity:.95}
    .badge{background:rgba(90,169,255,.15);color:#1e40af;border:1px solid rgba(90,169,255,.35);padding:2px 8px;border-radius:9999px;font-size:12px;font-weight:600}
    .group-btn{padding:0.5rem 1rem;border-radius:9999px;border:1px solid #bfdbfe;background:#eff6ff;color:#1e40af;font-weight:600;transition:all .2s}
    .group-btn:hover{background:#dbeafe;border-color:#93c5fd}
    .group-btn.active{background:linear-gradient(135deg,#3b82f6 0%,#60a5fa 100%);color:#fff;border-color:#3b82f6}
  </style>
</head>
<body class="bg-muted min-h-screen text-gray-800" style="font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'">
  <header class="header-container w-full">
    <div class="relative z-10 w-full p-8 md:p-10">
      <div class="flex items-center space-x-2 mb-3">
        <div class="inline-block px-3 py-1 rounded-full text-xs font-semibold text-white" style="background-color: rgba(255,255,255,0.15); backdrop-filter: blur(5px);">Tr∆∞·ªüng nh√≥m</div>
      </div>
      <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-white mb-1 tracking-tight">Module Duy·ªát B√°o C√°o</h1>
      <p class="text-blue-100 text-sm md:text-base">D√†nh cho tr∆∞·ªüng nh√≥m DQA.</p>
    </div>
  </header>

  <main class="w-full p-4 md:p-6">
    <div class="mb-4 flex items-center gap-2 flex-wrap">
      <button class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50 tab-btn active" data-target="form-approve">Duy·ªát b√°o c√°o</button>
      <button class="px-3 py-1 rounded-full border border-blue-200 bg-blue-50/30 text-primary-blue hover:bg-blue-50 tab-btn" data-target="form-pdform">Ph√™ duy·ªát form</button>
    </div>

    <section id="form-approve" class="bg-white p-4 md:p-6 rounded-xl shadow-md">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Danh s√°ch b√°o c√°o ch·ªù duy·ªát</h2>
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <label for="secret-code" class="hidden md:block">M√£ b·∫£o m·∫≠t</label>
          <input id="secret-code" type="password" placeholder="M√£ b·∫£o m·∫≠t" autocomplete="off" class="border border-blue-200 rounded bg-white text-xs px-2 py-1" style="min-width:160px" />
          <button id="btn-debug" class="px-2 py-0.5 rounded border border-amber-300 text-amber-700 bg-amber-50 hover:bg-amber-100">Debug</button>
        </div>
      </div>

      <!-- Group Filter -->
      <div class="mb-4 flex items-center gap-3 flex-wrap">
        <span class="text-sm font-medium text-gray-700">Ch·ªçn nh√≥m:</span>
        <button id="btn-group-all" class="group-btn active" data-group="all">T·∫•t c·∫£</button>
        <button id="btn-group-linh" class="group-btn" data-group="linh">
          <span class="mr-1">üë•</span> Nh√≥m Linh <span class="text-xs opacity-75">(8)</span>
        </button>
        <button id="btn-group-hieu" class="group-btn" data-group="hieu">
          <span class="mr-1">üë•</span> Nh√≥m Hi·∫øu <span class="text-xs opacity-75">(7)</span>
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-12 gap-3 mb-3">
        <div class="md:col-span-3">
          <label class="block text-sm text-gray-700 mb-1">T·ª´ kh√≥a</label>
          <input id="flt-q" type="text" placeholder="M√£/ti√™u ƒë·ªÅ/ng∆∞·ªùi l·∫≠p" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">Tr·∫°ng th√°i</label>
          <select id="flt-status" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
            <option value="Pending1" selected>Ch·ªù ph√™ duy·ªát</option>
            <option value="Pending2">Tr∆∞·ªüng nh√≥m Review</option>
            <option value="Approved">Done</option>
            <option value="TestBen">Test b·ªÅn</option>
            <option value="ChangesRequested">ƒêang s·ª≠a</option>
            <option value="All">T·∫•t c·∫£</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">T·ª´ ng√†y</label>
          <input id="flt-from" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white" />
        </div>
        <div class="md:col-span-2">
          <label class="block text-sm text-gray-700 mb-1">ƒê·∫øn ng√†y</label>
          <input id="flt-to" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white" />
        </div>
        <div class="md:col-span-3 flex items-end gap-2">
          <div class="flex items-center gap-2">
            <label class="text-xs text-gray-600">Ch·∫ø ƒë·ªô</label>
            <select id="flt-mode" class="border border-blue-200 rounded bg-white text-sm px-2 py-1">
              <option value="All" selected>T·∫•t c·∫£</option>
              <option value="Day">Ng√†y</option>
              <option value="Week">Tu·∫ßn</option>
              <option value="Month">Th√°ng</option>
            </select>
          </div>
          <button id="btn-search" class="submit-btn px-4 py-2 text-white font-semibold">Tra c·ª©u</button>
          <button id="btn-reset" class="px-4 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">X√≥a l·ªçc</button>
        </div>
      </div>

      <div id="debug-panel" class="mt-2 p-2 border border-amber-300 rounded bg-amber-50 text-xs" style="display:none">
        <div class="flex items-center justify-between mb-1">
          <div class="font-semibold">Debug API</div>
          <div class="flex items-center gap-2">
            <button id="dbg-load-json" class="px-2 py-0.5 rounded border border-blue-300 bg-white hover:bg-blue-50 text-blue-700">N·∫°p JSON th·ªß c√¥ng</button>
          </div>
        </div>
        <div class="mb-1">URL: <span id="dbg-url" class="break-all"></span></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          <div>
            <div class="text-gray-600 mb-1">Response (raw)</div>
            <textarea id="dbg-raw" class="w-full h-40 border rounded p-1"></textarea>
          </div>
          <div>
            <div class="text-gray-600 mb-1">First row (normalized)</div>
            <textarea id="dbg-row" class="w-full h-40 border rounded p-1"></textarea>
          </div>
        </div>
      </div>

      <div class="mt-2 overflow-auto border border-gray-200 rounded-lg">
        <table class="min-w-[1100px] w-full text-sm table-zebra table-vdiv">
          <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[120px]">M√£ b√°o c√°o</th>
              <th class="px-3 py-2 min-w-[260px]">Ti√™u ƒë·ªÅ</th>
              <th class="px-3 py-2 min-w-[160px]">Ng∆∞·ªùi l·∫≠p</th>
              <th class="px-3 py-2 min-w-[140px]">Ng√†y n·ªôp</th>
              <th class="px-3 py-2 min-w-[140px]">H·∫°n mong mu·ªën</th>
              <th class="px-3 py-2 min-w-[120px]">Tr·∫°ng th√°i</th>
              <th class="px-3 py-2 min-w-[160px]">K·∫øt lu·∫≠n</th>
              <th class="px-3 py-2 min-w-[220px]">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="list-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>

      <div id="pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="page-info">Trang 1/1 (0 d√≤ng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
          <select id="page-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <button id="prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Tr∆∞·ªõc</button>
          <button id="next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>
    </section>

    <!-- Section: Ph√™ duy·ªát form -->
    <section id="form-pdform" class="bg-white p-4 md:p-6 rounded-xl shadow-md" style="display:none">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-blue-800">Danh s√°ch form ch·ªù ph√™ duy·ªát</h2>
        <button id="pdform-btn-search" class="submit-btn px-4 py-2 text-white font-semibold">T·∫£i l·∫°i</button>
      </div>

      <div class="mb-3 flex items-center gap-3">
        <label class="text-sm text-gray-700 font-medium">L·ªçc theo k·∫øt qu·∫£:</label>
        <select id="pdform-flt-status" class="border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
          <option value="All">T·∫•t c·∫£</option>
          <option value="Leader review">Leader review</option>
          <option value="Ch·ªù TP ph√™ duy·ªát">Ch·ªù TP ph√™ duy·ªát</option>
          <option value="ƒê∆∞·ª£c duy·ªát">ƒê∆∞·ª£c duy·ªát</option>
        </select>
      </div>

      <div class="mt-2 overflow-auto border border-gray-200 rounded-lg">
        <table class="min-w-[1400px] w-full text-sm table-zebra table-vdiv">
              <thead class="bg-gradient-to-r from-blue-100 to-blue-50 sticky top-0">
            <tr class="text-left text-gray-700">
              <th class="px-3 py-2 min-w-[220px]">H√†nh ƒë·ªông</th>
              <th class="px-3 py-2 min-w-[200px]">T√™n t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[120px]">M√£</th>
              <th class="px-3 py-2 min-w-[180px]">M√£ t√°c v·ª•</th>
              <th class="px-3 py-2 min-w-[160px]">PIC</th>
              <th class="px-3 py-2 min-w-[160px]">K·∫øt qu·∫£</th>
              <th class="px-3 py-2 min-w-[160px]">Th·ªùi gian g·ª≠i</th>
              <th class="px-3 py-2 min-w-[180px]">Form b√°o c√°o</th>
              <th class="px-3 py-2 min-w-[120px]">Chi ti·∫øt</th>
            </tr>
          </thead>
          <tbody id="pdform-list-body" class="divide-y divide-gray-100">
            <tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>
          </tbody>
        </table>
      </div>

      <div id="pdform-pager" class="mt-2 flex items-center justify-between" style="display:none">
        <div class="text-sm text-gray-600">
          <span id="pdform-page-info">Trang 1/1 (0 d√≤ng)</span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Hi·ªÉn th·ªã</label>
          <select id="pdform-page-size" class="border border-blue-300 rounded-lg bg-slate-100 p-1 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white">
            <option value="10">10</option>
            <option value="20" selected>20</option>
            <option value="50">50</option>
          </select>
          <button id="pdform-prev" class="px-3 py-1 rounded-lg border border-gray-300 text-gray-700 bg-white hover:bg-gray-50">Tr∆∞·ªõc</button>
          <button id="pdform-next" class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105">Sau</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Modal Approve -->
  <div id="modal-approve" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-blue-800 mb-1">Duy·ªát b√°o c√°o</h3>
      <p class="text-sm text-gray-600 mb-3">Nh·∫≠p b√¨nh lu·∫≠n (kh√¥ng b·∫Øt bu·ªôc)</p>
      <textarea id="approve-comment" rows="4" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white" placeholder="Ghi ch√∫ cho ng∆∞·ªùi l·∫≠p..."></textarea>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-approve" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="approve-do" class="submit-btn px-4 py-2 text-white font-semibold">X√°c nh·∫≠n duy·ªát</button>
      </div>
    </div>
  </div>

  <!-- Modal Reject -->
  <div id="modal-reject" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-red-700 mb-1">T·ª´ ch·ªëi b√°o c√°o</h3>
      <p class="text-sm text-gray-600 mb-3">Vui l√≤ng n√™u l√Ω do</p>
      <textarea id="reject-reason" rows="4" class="w-full border border-red-300 rounded-lg bg-red-50 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white" placeholder="L√Ω do t·ª´ ch·ªëi..."></textarea>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-reject" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="reject-do" class="px-4 py-2 rounded-full text-white font-semibold" style="background:#ef4444">X√°c nh·∫≠n t·ª´ ch·ªëi</button>
      </div>
    </div>
  </div>

  <!-- Modal Request Changes -->
  <div id="modal-req" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-amber-700 mb-1">Y√™u c·∫ßu b·ªï sung</h3>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">B√¨nh lu·∫≠n y√™u c·∫ßu</label>
        <textarea id="req-comment" rows="4" class="w-full border border-amber-300 rounded-lg bg-amber-50 p-2 focus:outline-none focus:ring-2 focus:ring-amber-200 focus:bg-white" placeholder="N·ªôi dung c·∫ßn b·ªï sung..."></textarea>
      </div>
      <div class="mb-3">
        <label class="block text-sm text-gray-700 mb-1">H·∫°n b·ªï sung (kh√¥ng b·∫Øt bu·ªôc)</label>
        <input id="req-due" type="date" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white" />
      </div>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-req" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="req-do" class="px-4 py-2 rounded-full text-white font-semibold" style="background:#f59e0b">G·ª≠i y√™u c·∫ßu</button>
      </div>
    </div>
  </div>

  <!-- Modal Report Preview -->
  <div id="modal-report" class="modal" aria-hidden="true">
    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-0 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-2 border-b">
        <div class="text-sm text-gray-700">Xem b√°o c√°o: <span id="report-title" class="font-semibold"></span></div>
        <div class="flex items-center gap-2">
          <a id="report-open-new" href="#" target="_blank" class="text-primary-blue text-sm underline">M·ªü tab m·ªõi</a>
          <button data-close="modal-report" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
      <div class="h-[70vh]">
        <iframe id="report-frame" src="about:blank" class="w-full h-full" title="Report preview"></iframe>
      </div>
    </div>
  </div>

  <!-- Modal Task Detail -->
  <div id="modal-task" class="modal" aria-hidden="true">
    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-0 overflow-hidden">
      <div class="flex items-center justify-between px-4 py-2 border-b">
        <div class="text-sm text-gray-700">Chi ti·∫øt t√°c v·ª•: <span id="task-title" class="font-semibold"></span></div>
        <div class="flex items-center gap-2">
          <a id="task-open-new" href="#" target="_blank" class="text-primary-blue text-sm underline">M·ªü tab m·ªõi</a>
          <button data-close="modal-task" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">ƒê√≥ng</button>
        </div>
      </div>
      <div class="p-4 text-sm" id="task-content">ƒêang t·∫£i...</div>
    </div>
  </div>

  <!-- Modal Form Detail -->
  <div id="modal-form-detail" class="modal" aria-hidden="true">
    <div class="w-full max-w-4xl bg-white rounded-xl shadow-lg p-0 overflow-hidden max-h-[90vh] flex flex-col">
      <div class="flex items-center justify-between px-4 py-3 border-b flex-shrink-0">
        <div class="text-sm text-gray-700">Chi ti·∫øt form: <span id="form-detail-title" class="font-semibold"></span></div>
        <button data-close="modal-form-detail" class="px-3 py-1 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">ƒê√≥ng</button>
      </div>
      <div class="p-4 text-sm overflow-y-auto flex-1" id="form-detail-content">
        <div class="spinner mx-auto mb-2"></div>
        <p class="text-gray-600 text-center">ƒêang t·∫£i...</p>
      </div>
    </div>
  </div>

  <!-- Modal Form Approve -->
  <div id="modal-pdform-approve" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-blue-800 mb-1">Duy·ªát form</h3>
      <p class="text-sm text-gray-600 mb-3">Nh·∫≠p b√¨nh lu·∫≠n (kh√¥ng b·∫Øt bu·ªôc)</p>
      <textarea id="pdform-approve-comment" rows="4" class="w-full border border-blue-300 rounded-lg bg-slate-100 p-2 focus:outline-none focus:ring-2 focus:ring-blue-200 focus:bg-white" placeholder="Ghi ch√∫ cho ng∆∞·ªùi l·∫≠p..."></textarea>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-pdform-approve" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="pdform-approve-do" class="submit-btn px-4 py-2 text-white font-semibold">X√°c nh·∫≠n duy·ªát</button>
      </div>
    </div>
  </div>

  <!-- Modal Form Reject -->
  <div id="modal-pdform-reject" class="modal" aria-hidden="true">
    <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-4">
      <h3 class="text-lg font-semibold text-red-700 mb-1">T·ª´ ch·ªëi form</h3>
      <p class="text-sm text-gray-600 mb-3">Vui l√≤ng n√™u l√Ω do</p>
      <textarea id="pdform-reject-reason" rows="4" class="w-full border border-red-300 rounded-lg bg-red-50 p-2 focus:outline-none focus:ring-2 focus:ring-red-200 focus:bg-white" placeholder="L√Ω do t·ª´ ch·ªëi..."></textarea>
      <div class="mt-3 flex items-center justify-end gap-2">
        <button data-close="modal-pdform-reject" class="px-3 py-2 rounded-lg border border-gray-300 bg-white hover:bg-gray-50">H·ªßy</button>
        <button id="pdform-reject-do" class="px-4 py-2 rounded-full text-white font-semibold" style="background:#ef4444">X√°c nh·∫≠n t·ª´ ch·ªëi</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ===== Config
    const REPORTS_QUERY_URL = 'https://iatzhxxuk.tino.page/webhook/TracuuchoTNvaTP';
    const APPROVE_URL = 'https://iatzhxxuk.tino.page/webhook/Duyetbaocaochotruongnhom1';
    const WEBHOOK_DETAIL = 'https://iatzhxxuk.tino.page/webhook/1df40252-6bff-4392-bb1a-5ae72ee748d1';

    // ===== Ph√™ duy·ªát Form Endpoints
    const PDFORM_QUERY_URL = 'https://iatzhxxuk.tino.page/webhook/PheduyenformTP'; // GET: l·∫•y danh s√°ch form ch·ªù ph√™ duy·ªát
    const PDFORM_ACTION_URL = 'https://iatzhxxuk.tino.page/webhook/DuyetformTN'; // POST: action=pdform_approve|pdform_reject

    // ===== Group Definitions
    const NHOM_LINH = [
      'B√πi ƒê·∫∑ng Qu·ªëc Huy',
      'Nguy·ªÖn H·ªØu Th·ªãnh',
      'Tr·∫ßn Hi·∫øu Nghƒ©a',
      'L·∫°i Qu·ªëc L·ªôc',
      'L√™ Ng·ªçc √Ånh',
      'L√™ VƒÉn S∆°n',
      'Nguy·ªÖn Th·ªã Hi·ªÅn',
      'Ph·∫°m Th·ªã Minh'
    ];

    const NHOM_HIEU = [
      'ƒê·ªó Quang Long',
      'Ph·∫°m Th√†nh Trung Ki√™n',
      'Th√°i Th·ªã Giang',
      'V≈© Th·ªã H·∫±ng',
      'ƒê√†o Tu·∫•n K·ª≥',
      'L√™ Th·ªã Th·∫£o',
      'V≈© Th·ªã Thanh Hi·ªÅn'
    ];

    // ===== State
    let ALL_ITEMS = [];
    let FILTERED = [];
    let CURRENT_PAGE = 1;
    let PAGE_SIZE = 20;
    let CURRENT_ITEM_ID = null;
    let CURRENT_ACTION = null;
    let SELECTED_GROUP = 'all'; // 'all' | 'linh' | 'hieu'

    // Ph√™ duy·ªát Form state
    let PDFORM_ITEMS = [];
    let PDFORM_FILTERED = [];
    let PDFORM_PAGE = 1;
    let PDFORM_PAGE_SIZE = 20;
    let CURRENT_PDFORM_ID = null;

    // ===== Helpers
    function normalizeVietnamese(str){
      return String(str||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    }

    function isInGroup(reporterName, group){
      if (group === 'all') return true;
      const normalized = normalizeVietnamese(reporterName);
      const targetGroup = group === 'linh' ? NHOM_LINH : NHOM_HIEU;
      return targetGroup.some(name => normalizeVietnamese(name) === normalized);
    }

    function showToast(message, type){
      const el = document.getElementById('toast'); if (!el) return;
      el.textContent = String(message||'');
      el.style.background = type==='error' ? '#b91c1c' : '#0b1324';
      el.classList.add('show');
      setTimeout(()=> el.classList.remove('show'), 2200);
    }

    function generateQaPdCode(){
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let suffix = '';
      for (let i=0; i<6; i++){ suffix += chars.charAt(Math.floor(Math.random()*chars.length)); }
      return `QA.RV.${yyyy}${mm}${dd}-${suffix}`;
    }

    function openModal(id){ const m=document.getElementById(id); if(m){ m.classList.add('open'); m.setAttribute('aria-hidden','false'); } }
    function closeModal(id){ const m=document.getElementById(id); if(m){ m.classList.remove('open'); m.setAttribute('aria-hidden','true'); } }

    function parseDateFlexible(s){
      try{
        const v = String(s||'').trim(); if (!v) return null;
        if (/^\d{4}-\d{2}-\d{2}/.test(v)) return new Date(v);
        const m = v.match(/(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{2,4})/);
        if (m){ const d=Number(m[1]), mm=Number(m[2])-1, y=Number(m[3]<100?('20'+m[3]):m[3]); return new Date(y,mm,d); }
        const t = Date.parse(v); return isNaN(t)?null:new Date(t);
      }catch(_){ return null; }
    }

    function fmtDmy(s){ const d=parseDateFlexible(s); if(!d) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); return `${dd}/${mm}/${yy}`; }
    function nowIsoMinute(){ const d=new Date(); const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${yy}-${mm}-${dd} ${hh}:${mi}`; }
    function nowViMinute(){ const d=new Date(); const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yy=d.getFullYear(); const hh=String(d.getHours()).padStart(2,'0'); const mi=String(d.getMinutes()).padStart(2,'0'); return `${dd}/${mm}/${yy} ${hh}:${mi}`; }
    function appendRowParams(p, it){
      try{
        const row = it || {};
        p.append('header_code','M√£ b√°o c√°o'); p.append('field_code','code'); p.append('code', String(row.code||''));
        p.append('header_title','Ti√™u ƒë·ªÅ'); p.append('field_title','title'); p.append('title', String(row.title||''));
        p.append('header_reporter','Ng∆∞·ªùi l·∫≠p'); p.append('field_reporter','reporter'); p.append('reporter', String(row.reporter||''));
        p.append('header_reporterEmail','Email'); p.append('field_reporterEmail','reporterEmail'); p.append('reporterEmail', String(row.reporterEmail||''));
        p.append('header_submitDate','Ng√†y n·ªôp'); p.append('field_submitDate','submitDate'); p.append('submitDate', String(row.submitDate||''));
        p.append('header_wishDate','H·∫°n mong mu·ªën'); p.append('field_wishDate','wishDate'); p.append('wishDate', String(row.wishDate||''));
        p.append('header_dueDate','H·∫°n ƒë√°nh gi√°'); p.append('field_dueDate','dueDate'); p.append('dueDate', String(row.dueDate||''));
        p.append('header_status','Tr·∫°ng th√°i'); p.append('field_status','status'); p.append('status', String(row.status||''));
        p.append('header_conclusion','K·∫øt lu·∫≠n'); p.append('field_conclusion','conclusion'); p.append('conclusion', String(row.conclusion||''));
        p.append('header_reportUrl','Li√™n k·∫øt b√°o c√°o'); p.append('field_reportUrl','reportUrl'); p.append('reportUrl', String(row.reportUrl||''));
        p.append('header_sentTime','Th·ªùi gian g·ª≠i'); p.append('field_sentTime','sent_time'); p.append('sent_time', nowViMinute());
        p.append('header_sentTimeISO','Th·ªùi gian g·ª≠i (ISO ph√∫t)'); p.append('field_sentTimeISO','sent_time_iso'); p.append('sent_time_iso', nowIsoMinute());
      }catch(_){ }
    }
      function canonicalStatus(s){
      const v = String(s||'')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
        .replace(/\s+/g,'')
        .toLowerCase();
      if (['pending1','chopheduyet1','cpd1','pending01','pending_1'].includes(v)) return 'pending1';
      if (['pending2','chopheduyet2','cpd2','pending02','pending_2','truongnhomreview'].includes(v)) return 'pending2';
      if (['pending','chopheduyet','cho_duyet','cho'].includes(v)) return 'pending1';
      if (['cancel','canceled','cancelled','huy','huybo','huybo_','dahuy','da_huy','huyyeu_cau','huyyeucau'].includes(v)) return 'cancel';
      if (['doing','inprogress','dang','danglam','dangthuchien','dang_thuc_hien'].includes(v)) return 'doing';
      if (['approved','done','hoanthanh','daduyet','dauyet'].includes(v)) return 'approved';
      if (['changesrequested','dangsua','yeucaubosung','sua'].includes(v)) return 'changesrequested';
      if (['testben','test_ben'].includes(v)) return 'testben';
      if (['rejected','tuchoi'].includes(v)) return 'rejected';
      return v;
    }

    // ===== Employee mapping
    const EMPLOYEE_EMAIL = (()=>{
      const normalize = s => String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,' ').trim().toLowerCase();
      const raw = {
        "B√πi ƒê·∫∑ng Qu·ªëc Huy":"huy.bui@karofi.vn",
        "ƒê√†o Ho√†ng D∆∞∆°ng":"duong.dao@karofi.vn",
        "ƒê·ªó Quang Long":"long.do@karofi.vn",
        "H√† M·ªπ Linh":"linh.ha@karofi.vn",
        "Nguy·ªÖn H·ªØu Th·ªãnh":"thinh.nguyen2@karofi.vn",
        "Nguy·ªÖn VƒÉn Hi·∫øu":"hieu.nguyen2@karofi.vn",
        "Nguy·ªÖn VƒÉn Linh":"linh.nguyen@karofi.vn",
        "Ph·∫°m Th√†nh Trung Ki√™n":"kien.pham1@karofi.vn",
        "Th√°i Th·ªã Giang":"giang.thai@karofi.vn",
        "Tr·∫ßn Hi·∫øu Nghƒ©a":"nghia.tran@karofi.vn",
        "V≈© Th·ªã H·∫±ng":"hang.vu@karofi.vn",
        "ƒê√†o Tu·∫•n K·ª≥":"ky.dao@karofi.vn",
        "ƒê·ªó Th·∫ø C∆∞·ªùng":"cuong.do@karofi.vn",
        "L·∫°i Qu·ªëc L·ªôc":"loc.lai@karofi.vn",
        "L√™ Ng·ªçc √Ånh":"anh.le1@karofi.vn",
        "L√™ Th·ªã Thanh Nh√†n":"nhan.le@karofi.vn",
        "L√™ Th·ªã Th·∫£o":"thao.le@karofi.vn",
        "L√™ VƒÉn S∆°n":"son.le2@karofi.vn",
        "Nguy·ªÖn Th·ªã Hi·ªÅn":"hien.nguyen1@karofi.vn",
        "Ph·∫°m Th·ªã Minh":"minh.pham1@karofi.vn",
        "V≈© Duy Minh":"minh.vu@karofi.vn",
        "V≈© Th·ªã Thanh Hi·ªÅn":"hien.vu2@karofi.vn"
      };
      const map = {}; Object.keys(raw).forEach(k => map[normalize(k)] = raw[k]);
      return { get: (name)=> map[normalize(name)] || '' };
    })();

    // ===== Data fetching
    async function fetchReports(params){
      const headerMapReports = {
        header_id: 'ID',
        field_id: 'id',
        header_code: 'M√£ b√°o c√°o',
        field_code: 'code',
        header_title: 'Ti√™u ƒë·ªÅ',
        field_title: 'title',
        header_reporter: 'Ng∆∞·ªùi l·∫≠p',
        field_reporter: 'reporter',
        header_reporterEmail: 'Email',
        field_reporterEmail: 'reporterEmail',
        header_submitDate: 'Ng√†y n·ªôp',
        field_submitDate: 'submitDate',
        header_wishDate: 'H·∫°n mong mu·ªën',
        field_wishDate: 'wishDate',
        header_dueDate: 'H·∫°n ƒë√°nh gi√°',
        field_dueDate: 'dueDate',
        header_status: 'Tr·∫°ng th√°i',
        field_status: 'status',
        header_conclusion: 'K·∫øt lu·∫≠n',
        field_conclusion: 'conclusion',
        header_reportUrl: 'Li√™n k·∫øt b√°o c√°o',
        field_reportUrl: 'reportUrl'
      };

      const normalizeDate = (v)=>{ const d=parseDateFlexible(v); if(!d) return ''; const yy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; };
      const fromRaw = params && typeof params.from==='string' ? params.from : '';
      const toRaw = params && typeof params.to==='string' ? params.to : '';
      const qRaw = params && typeof params.q==='string' ? params.q : '';
      const statusRaw = params && typeof params.status==='string' ? params.status : '';
      const modeRaw = params && typeof params.mode==='string' ? params.mode : '';
      const pageRaw = params && (params.page!==undefined) ? String(params.page) : '';
      const pageSizeRaw = params && (params.pageSize!==undefined) ? String(params.pageSize) : '';

      const fromIso = normalizeDate(fromRaw);
      const toIso = normalizeDate(toRaw);
      const dateParams = {};
      if (fromIso){ Object.assign(dateParams, { from:fromIso, fromDate:fromIso, date_from:fromIso, start_date:fromIso, submitFrom:fromIso, ngay_tu:fromIso }); }
      if (toIso){ Object.assign(dateParams, { to:toIso, toDate:toIso, date_to:toIso, end_date:toIso, submitTo:toIso, ngay_den:toIso }); }

      const qParams = {};
      if (qRaw){ Object.assign(qParams, { q:qRaw, keyword:qRaw, search:qRaw, s:qRaw, code:qRaw, title:qRaw, reporter:qRaw }); }

      function statusToViLabel(code){
        const m = {
          Pending1:'Ch·ªù ph√™ duy·ªát',
          Pending2:'Tr∆∞·ªüng nh√≥m Review',
          Pending:'Ch·ªù ph√™ duy·ªát',
          Approved:'Done',
          ChangesRequested:'ƒêang s·ª≠a',
          TestBen:'Test b·ªÅn',
          Rejected:'T·ª´ ch·ªëi'
        };
        return m[code] || code;
      }
      const statusParams = {};
      if (statusRaw && statusRaw!=='All'){
        // V·ªõi nh√≥m ch·ªù (Pending1/Pending2) kh√¥ng filter theo tr·∫°ng th√°i ƒë·ªÉ kh√¥ng lo·∫°i "Tr∆∞·ªüng nh√≥m Review"
        const isPendingGroup = ['Pending','Pending1','Pending2'].includes(String(statusRaw));
        if (!isPendingGroup){
          const labelVi = statusToViLabel(statusRaw);
          Object.assign(statusParams, {
            status: labelVi,
            state: labelVi,
            trangthai: labelVi,
            status_vi: labelVi,
            status_code: statusRaw
          });
        }
      }

      const modeParams = {};
      if (modeRaw && modeRaw!=='All'){
        Object.assign(modeParams, { mode:modeRaw, range:modeRaw, period:modeRaw });
      }

      const pageParams = {};
      const pg = Math.max(1, parseInt(pageRaw||'1', 10)||1);
      const ps = Math.max(1, parseInt(pageSizeRaw||'20', 10)||20);
      const offset = (pg-1)*ps;
      Object.assign(pageParams, { page:String(pg), page_index:String(pg), pageNumber:String(pg), pageSize:String(ps), limit:String(ps), size:String(ps), per_page:String(ps), offset:String(offset) });

      // G·ª≠i k√®m Tr·∫°ng th√°i khi get d·ªØ li·ªáu
      const statusParamsToSend = {};
      if (statusRaw && statusRaw !== 'All') {
        const labelVi = statusToViLabel(statusRaw);
        Object.assign(statusParamsToSend, {
          status: labelVi,
          state: labelVi,
          trangthai: labelVi,
          status_vi: labelVi,
          status_code: statusRaw
        });
      } else if (statusRaw === 'All') {
        Object.assign(statusParamsToSend, {
          status: 'All',
          status_code: 'All'
        });
      }

      const qs = new URLSearchParams({ action:'reports_query', ...headerMapReports, ...statusParamsToSend, _ts: Date.now().toString() });
      function setDebug(url, raw, first){ try{ const u=document.getElementById('dbg-url'); if(u) u.textContent = url; const t=document.getElementById('dbg-raw'); if(t) t.value = raw||''; const f=document.getElementById('dbg-row'); if(f) f.value = first? JSON.stringify(first,null,2):''; }catch(_){ } }
      async function fetchJson(url){ const full=`${url}?${qs.toString()}`; const r = await fetch(full, { method:'GET', cache:'no-store' }); const txt = await r.text(); let parsed=null; try{ parsed=JSON.parse(txt);}catch{} setDebug(full, (txt && txt.length? txt: '[empty]').slice(0,4000), null); return { ok:r.ok, parsed, raw:txt, status:r.status, fullUrl:full }; }
      async function postJson(url, params){ const body = new URLSearchParams(params||{}); const r = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: body.toString(), cache:'no-store' }); const txt = await r.text(); let parsed=null; try{ parsed=JSON.parse(txt);}catch{} setDebug(url+' [POST]', (txt && txt.length? txt: '[empty]').slice(0,4000), null); return { ok:r.ok, parsed, raw:txt, status:r.status, fullUrl:url+' [POST]' }; }
      async function fetchJsonMinimal(url){
        const qs2 = new URLSearchParams({ action:'reports_query', ...headerMapReports, ...statusParamsToSend, _ts: Date.now().toString() });
        const full=`${url}?${qs2.toString()}`; const r=await fetch(full,{method:'GET'}); const txt=await r.text(); let parsed=null; try{ parsed=JSON.parse(txt);}catch{} setDebug(full, txt.slice(0,4000), null); return { ok:r.ok, parsed, raw:txt, status:r.status, fullUrl:full };
      }
      function safeParse(txt){ try{ return JSON.parse(txt); }catch(_){ return null; } }
      // Gom to√†n b·ªô c√°c m·∫£ng object xu·∫•t hi·ªán trong JSON, kh√¥ng ch·ªâ m·∫£ng ƒë·∫ßu ti√™n
      function collectRowsDeep(json){
        if(!json) return [];
        if(Array.isArray(json)) return json;
        const out=[]; const seen=new Set(); const q=[json];
        try{
          while(q.length){
            const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur);
            for(const v of Object.values(cur)){
              if(Array.isArray(v)){
                if(v.length && typeof v[0]==='object') out.push(...v);
                v.forEach(x=>{ if(x && typeof x==='object') q.push(x); });
                continue;
              }
              if(typeof v==='string'){
                const j = safeParse(v); if(j){ q.push(j); continue; }
              }
              if(v && typeof v==='object') q.push(v);
            }
          }
        }catch(_){ }
        return out.length? out: (typeof json==='object'? [json]: []);
      }
      let resp = await fetchJson(REPORTS_QUERY_URL);
      try{ console.log('[Reports] URL:', resp.fullUrl, 'status:', resp.status); }catch(_){ }
      // Fallback 1: n·∫øu body r·ªóng nh∆∞ng status OK, th·ª≠ g·ªçi t·ªëi gi·∫£n (b·ªè b·ªô l·ªçc) ƒë·ªÉ x√°c th·ª±c
      if (resp.ok && (!resp.raw || !String(resp.raw).trim())){
        try{ console.warn('[Reports] Empty body, retry with minimal params'); }catch(_){ }
        resp = await fetchJsonMinimal(REPORTS_QUERY_URL);
      }
      if (!resp.ok) return [];
      // Fallback 2: POST v·ªõi c√πng tham s·ªë n·∫øu GET tr·∫£ r·ªóng
      if (resp.ok && (!resp.raw || !String(resp.raw).trim())){
        try{ console.warn('[Reports] Empty body on GET, retry with POST'); }catch(_){ }
        const postParams = { action:'reports_query', ...Object.fromEntries(qs.entries()) };
        delete postParams._ts; // s·∫Ω sinh l·∫°i timestamp m·ªõi
        resp = await postJson(REPORTS_QUERY_URL, { ...postParams, _ts: Date.now().toString() });
      }
      // N·∫øu POST v·∫´n r·ªóng, th·ª≠ POST t·ªëi gi·∫£n
      if (resp.ok && (!resp.raw || !String(resp.raw).trim())){
        const minimal = { action:'reports_query', ...headerMapReports, ...statusParamsToSend, _ts: Date.now().toString() };
        resp = await postJson(REPORTS_QUERY_URL, minimal);
      }
      const baseJson = resp.parsed ?? safeParse(resp.raw);
      const rows = collectRowsDeep(baseJson);
      try{ console.log('[Reports] rows.length =', rows?.length||0); }catch(_){ }
      function normalizeStatus(val){
        const v = String(val||'').trim().toLowerCase();
        const v2 = v.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'');
        if (!v) return 'Pending1';
        // Pending 1
        if ([
          'pending1','pending 1','cho phe duyet 1','ch·ªù ph√™ duy·ªát 1','cho_phe_duyet_1','cho duyet 1','chopheduyet1','cpd1'
        ].includes(v)) return 'Pending1';
        // Pending 2 - x·ª≠ l√Ω c·∫£ "Tr∆∞·ªüng" v√† "Tr∆∞·ªùng" (l·ªói ch√≠nh t·∫£)
        if ([
          'pending2','pending 2','cho phe duyet 2','ch·ªù ph√™ duy·ªát 2','cho_phe_duyet_2','cho duyet 2','chopheduyet2','cpd2'
        ].includes(v) || v2==='truongnhomreview' || 
           v.includes('tr∆∞·ªüng nh√≥m review') || v.includes('tr∆∞·ªùng nh√≥m review') || 
           v.includes('truong nhom review')) return 'Pending2';
        // Generic pending -> map v·ªÅ Pending1 cho Tr∆∞·ªüng nh√≥m
        if (['pending','cho phe duyet','ch·ªù ph√™ duy·ªát','cho_duyet','cho'].includes(v)) return 'Pending1';
        if (['approved','done','hoan thanh','ho√†n th√†nh','da duyet','ƒë√£ duy·ªát'].includes(v)) return 'Approved';
        if (['changesrequested','dang sua','ƒëang s·ª≠a','yeu cau bo sung','y√™u c·∫ßu b·ªï sung','sua'].includes(v)) return 'ChangesRequested';
        if (['test ben','test_ben','testben'].includes(v)) return 'TestBen';
        if (['rejected','tu choi','t·ª´ ch·ªëi'].includes(v)) return 'Rejected';
        return val;
      }
      function lowerKeyMap(obj){
        const map={};
        try{ Object.keys(obj||{}).forEach(k=>{ map[String(k).toLowerCase()] = obj[k]; }); }catch(_){ }
        return map;
      }
      function getFrom(lowerObj, ...keys){
        for(const k of keys){
          const kk = String(k||'').toLowerCase();
          if (lowerObj.hasOwnProperty(kk)) return lowerObj[kk];
        }
        return '';
      }
      const normalizedRows = rows.map(x=>{
        const lx = lowerKeyMap(x||{});
        const id = getFrom(lx,'id','ID','Id','reportId','report_id');
        const code = getFrom(lx,'code','m√£ b√°o c√°o','ma','taskcode','reportCode','m√£ t√°c v·ª•','M√£ t√°c v·ª•');
        const title = getFrom(lx,'title','ti√™u ƒë·ªÅ','name','reportTitle','t√™n','task name','Task Name');
        const reporter = getFrom(lx,'reporter','ng∆∞·ªùi l·∫≠p','employee','author','nh√¢n vi√™n','assignee','Assignee');
        const reporterEmail = getFrom(lx,'reporterEmail','email');
        const submitDate = getFrom(lx,'submitDate','ng√†y n·ªôp','date','ngaynop','ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t','Ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t');
        const wishDate = getFrom(lx,'wishDate','h·∫°n mong mu·ªën','hanmongmuon','wish','H·∫°n mong mu·ªën');
        const dueDate = getFrom(lx,'dueDate','deadline','h·∫°n ƒë√°nh gi√°','ng√†y ho√†n th√†nh th·ª±c t·∫ø','Ng√†y ho√†n th√†nh th·ª±c t·∫ø');
        const statusRaw = getFrom(lx,'status','tr·∫°ng th√°i','trangthai','k·∫øt qu·∫£','K·∫øt qu·∫£');
        const conclusion = getFrom(lx,'conclusion','k·∫øt lu·∫≠n','ketluan','K·∫øt lu·∫≠n');
        const reportUrl = getFrom(lx,'reportUrl','li√™n k·∫øt b√°o c√°o','url','link','href','link bcpdf','Link BCpdf');
        // Map chuy√™n bi·ªát: n·∫øu status l√† "Ch·ªù ph√™ duy·ªát 1/2" th√¨ normalize v·ªÅ Pending1/Pending2
        return {
          id: id || code || '',
          code: code || id || '',
          title: title || '',
          reporter: reporter || '',
          reporterEmail: reporterEmail || '',
          submitDate: submitDate || '',
          wishDate: wishDate || '',
          dueDate: dueDate || '',
          status: (function(){
            const s = String(statusRaw||'').trim().toLowerCase();
            const sNorm = s.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'');
            if (s.includes('ch·ªù ph√™ duy·ªát 1') || s.includes('cho phe duyet 1')) return 'Pending1';
            // X·ª≠ l√Ω c·∫£ "Tr∆∞·ªüng" v√† "Tr∆∞·ªùng" (l·ªói ch√≠nh t·∫£) sau khi normalize
            if (s.includes('ch·ªù ph√™ duy·ªát 2') || s.includes('cho phe duyet 2') || 
                s.includes('tr∆∞·ªüng nh√≥m review') || s.includes('tr∆∞·ªùng nh√≥m review') || 
                s.includes('truong nhom review') || sNorm === 'truongnhomreview') return 'Pending2';
            return normalizeStatus(statusRaw || 'Pending1');
          })(),
          conclusion: conclusion || '',
          reportUrl: reportUrl || ''
        };
      });
      // Lo·∫°i b·ªè c√°c d√≤ng r·ªóng/kh√¥ng ƒë·ªß th√¥ng tin v√† tr√πng l·∫∑p ƒë·ªÉ tr√°nh hi·ªÉn th·ªã h√†ng tr·ªëng
      const isMeaningful = (r)=>{
        const hasId = String(r?.id||'').trim().length>0;
        const hasMain = ['code','title','reporter','reportUrl'].some(k=> String(r?.[k]||'').trim().length>0);
        return hasId || hasMain;
      };
      const seenKeys = new Set();
      const cleanedRows = normalizedRows.filter(r=>{
        if (!isMeaningful(r)) return false;
        const key = [r.id,r.code,r.title,r.reporter,r.submitDate,r.reportUrl].map(x=> String(x||'').trim().toLowerCase()).join('|');
        if (seenKeys.has(key)) return false; seenKeys.add(key); return true;
      });
      try{ setDebug(resp.fullUrl||'', resp.raw||'', cleanedRows[0]||null); if(!resp.raw || !String(resp.raw).trim()){ const panel=document.getElementById('debug-panel'); if(panel) panel.style.display='block'; } }catch(_){ }
      // Log th·ªëng k√™ theo tr·∫°ng th√°i ƒë·ªÉ d·ªÖ debug
      try{
        const statusCounts = (cleanedRows||[]).reduce((acc, it)=>{
          const k = String(it?.status||'').toLowerCase(); acc[k] = (acc[k]||0)+1; return acc;
        }, {});
        console.log('[Reports] status counts =', statusCounts);
      }catch(_){ }
      return cleanedRows;
    }

    // ===== Render
    function applyFilters(all){
      const q = (document.getElementById('flt-q')?.value || '').trim().toLowerCase();
      const st = (document.getElementById('flt-status')?.value || 'All');
      const from = parseDateFlexible(document.getElementById('flt-from')?.value || '');
      const to   = parseDateFlexible(document.getElementById('flt-to')?.value || '');
      const out = all.filter(it=>{
        const okQ = !q || [it.code,it.title,it.reporter].join(' ').toLowerCase().includes(q);
        const canon = canonicalStatus(it.status);
        // Lo·∫°i b·ªè Cancel/Doing khi ch·ªçn "T·∫•t c·∫£"
        const okAllPrune = (st==='All') ? (!['cancel','doing'].includes(canon)) : true;
        const okS = (st==='All') || (canon===canonicalStatus(st));
        // N·∫øu ch·ªçn Pending1: ch·ªâ cho Tr∆∞·ªüng nh√≥m xem c√°c b√°o c√°o ·ªü Pending1
        // N·∫øu ch·ªçn Pending2: ch·ªâ xem c√°c b√°o c√°o chuy·ªÉn l√™n Tr∆∞·ªüng ph√≤ng
        const okG = isInGroup(it.reporter, SELECTED_GROUP);
        let okD = true;
        const sub = parseDateFlexible(it.submitDate);
        // Ngo·∫°i l·ªá: Pending1/Pending2 kh√¥ng tu√¢n theo l·ªçc th·ªùi gian
        if (!['pending1','pending2'].includes(canon)){
          if (from && sub) okD = okD && (sub.getTime() >= new Date(from.getFullYear(),from.getMonth(),from.getDate()).getTime());
          if (to && sub) okD = okD && (sub.getTime() <= new Date(to.getFullYear(),to.getMonth(),to.getDate(),23,59,59,999).getTime());
        }
        return okQ && okS && okG && okD && okAllPrune;
      });
      // ∆Øu ti√™n hi·ªÉn th·ªã Pending1/Pending2 l√™n ƒë·∫ßu, sau ƒë√≥ s·∫Øp theo ng√†y n·ªôp m·ªõi nh·∫•t
      out.sort((a,b)=>{
        const pa = ['pending1','pending2'].includes(canonicalStatus(a.status)) ? 0 : 1;
        const pb = ['pending1','pending2'].includes(canonicalStatus(b.status)) ? 0 : 1;
        if (pa!==pb) return pa-pb;
        const ta = parseDateFlexible(a.submitDate)?.getTime()||0;
        const tb = parseDateFlexible(b.submitDate)?.getTime()||0;
        return tb - ta;
      });
      return out;
    }

    function updatePager(total){
      const pager = document.getElementById('pager');
      const info = document.getElementById('page-info');
      const ps = PAGE_SIZE; const pages = Math.max(1, Math.ceil(total/ps));
      if (CURRENT_PAGE > pages) CURRENT_PAGE = pages;
      if (info) info.textContent = `Trang ${CURRENT_PAGE}/${pages} (${total} d√≤ng)`;
      pager.style.display = total>0 ? 'flex' : 'none';
    }

    function renderTable(){
      const body = document.getElementById('list-body'); if (!body) return;
      try{ console.log('[Render] FILTERED length =', FILTERED?.length||0, 'group=', SELECTED_GROUP); }catch(_){ }
      const total = FILTERED.length; updatePager(total);
      if (!total){ body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="8">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'; return; }
      const start = (CURRENT_PAGE-1)*PAGE_SIZE; const end = Math.min(total, start+PAGE_SIZE);
      const pageItems = FILTERED.slice(start,end);
      body.innerHTML = pageItems.map(it=>{
        let trClass = '';
        const statusBadge = ({
          'Pending1': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-200">Ch·ªù ph√™ duy·ªát</span>',
          'Pending2': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-200">Tr∆∞·ªüng nh√≥m Review</span>',
          'Approved': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-200">Done</span>',
          'ChangesRequested': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-200">ƒêang s·ª≠a</span>',
          'TestBen': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-indigo-50 text-indigo-700 border border-indigo-200">Test b·ªÅn</span>',
          'Rejected': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-50 text-red-700 border border-red-200">T·ª´ ch·ªëi</span>'
        })[String(it.status||'Pending1')] || String(it.status||'');
        const canApprove = String(it.status||'')==='Pending2';
        const canOther = ['Pending1','Pending2'].includes(String(it.status||''));
        // N·∫øu ch∆∞a nh·∫≠p ƒë√∫ng m√£ b·∫£o m·∫≠t (nguyenvanlinh|nguyenvanhieu) th√¨ c≈©ng kh√≥a n√∫t Duy·ªát
        (function(){})();
        const _secEl = document.getElementById('secret-code');
        const _secRaw = String((_secEl||{}).value||'');
        const _secNorm = _secRaw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase();
        const hasCode = ['nguyenvanlinh','nguyenvanhieu'].includes(_secNorm);
        const disApprove = (canApprove && hasCode) ? '' : 'opacity-50 pointer-events-none';
        const disOther = canOther ? '' : 'opacity-50 pointer-events-none';
        return `
          <tr class="${trClass}">
            <td class="px-3 py-2"><a href="#" class="text-blue-700 underline report-link" data-id="${it.id}">${it.code}</a></td>
            <td class="px-3 py-2"><a href="#" class="text-blue-700 hover:underline task-detail-link" data-id="${it.id}">${it.title}</a></td>
            <td class="px-3 py-2"><div>${it.reporter}</div>${it.reporterEmail?`<div class=\"text-xs text-gray-500\">${it.reporterEmail}</div>`:''}</td>
            <td class="px-3 py-2">${fmtDmy(it.submitDate)}</td>
            <td class="px-3 py-2">${fmtDmy(it.wishDate)}</td>
            <td class="px-3 py-2">${statusBadge}</td>
            <td class="px-3 py-2">${it.conclusion?String(it.conclusion):''}</td>
            <td class="px-3 py-2">
              <div class="flex items-center gap-2">
                <button class="px-3 py-1 rounded-full text-white font-semibold bg-primary-blue hover:brightness-105 act-approve ${disApprove}" data-id="${it.id}">Duy·ªát</button>
                <button class="px-3 py-1 rounded-full text-white font-semibold act-reject ${disOther}" style="background:#ef4444" data-id="${it.id}">T·ª´ ch·ªëi</button>
                <button class="px-3 py-1 rounded-full text-white font-semibold act-request ${disOther}" style="background:#f59e0b" data-id="${it.id}">Y√™u c·∫ßu b·ªï sung</button>
              </div>
            </td>
          </tr>`;
      }).join('');
    }

    // ===== Helpers
    function escapeHtml(input){
      try{
        const s = String(input||'');
        const map = { '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' };
        return s.replace(/[&<>"']/g, (ch)=> map[ch] || ch);
      }catch(_){ return ''; }
    }

    // ===== Actions
    function findItem(id){ return ALL_ITEMS.find(x=> String(x.id)===String(id)); }

    async function openTaskDetail(id){
      const modalId='modal-task'; const titleEl=document.getElementById('task-title'); const content=document.getElementById('task-content'); const openNew=document.getElementById('task-open-new');
      const it=findItem(id); if(titleEl) titleEl.textContent = it? `${it.code} ‚Äî ${it.title}` : String(id||'');
      if(content) content.textContent='ƒêang t·∫£i...';
      let url=''; let detailHtml='';

      const headerMapDetail = {
        header_id:'ID', field_id:'id', header_code:'M√£', field_code:'code', header_title:'T√™n t√°c v·ª•', field_title:'title',
        header_requester:'Ng∆∞·ªùi y√™u c·∫ßu', field_requester:'requesterName', header_requesterDept:'Ph√≤ng ban y√™u c·∫ßu', field_requesterDept:'requesterDept', header_receiver:'Ng∆∞·ªùi nh·∫≠n m·∫´u', field_receiver:'receiverName',
        header_form:'Form ƒë√°nh gi√°', field_form:'formName', header_manhour:'C√¥ng chu·∫©n', field_manhour:'manhour',
        header_requestDate:'Ng√†y y√™u c·∫ßu', field_requestDate:'requestDate', header_wishDate:'H·∫°n mong mu·ªën', field_wishDate:'wishDate',
        header_purpose:'M·ª•c ƒë√≠ch ƒë√°nh gi√°', field_purpose:'purpose', header_note:'Note', field_note:'note', header_special:'Y√™u c·∫ßu test ƒë·∫∑c bi·ªát', field_special:'specialTest',
        header_link:'Link', field_link:'link'
      };
      const qs=new URLSearchParams({ action:'task_detail', ...headerMapDetail, id:String(id), _ts:Date.now().toString() });
      async function fetchJson(u){ const r=await fetch(`${u}?${qs.toString()}`, { method:'GET' }); const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch{} return { ok:r.ok, parsed:j, raw:t, status:r.status }; }
      function pickObj(j){ if(!j) return null; if(Array.isArray(j) && j.length) return j[0]; if(typeof j==='object') return j; try{ const q=[j]; const seen=new Set(); while(q.length){ const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); if(Object.keys(cur).length) return cur; for(const v of Object.values(cur)){ if(v && typeof v==='object') q.push(v); } } }catch(_){ } return null; }
      let resp=await fetchJson(WEBHOOK_DETAIL);
      const obj=pickObj(resp.parsed ?? (resp.raw? JSON.parse(resp.raw): null)) || {};
      const get=(...keys)=>{ for(const k of keys){ const v=obj[k]||obj[k?.toLowerCase?.()]; if(v!==undefined) return v; } return ''; };
      url = get('link','url','href')||'';
      detailHtml = `<div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
        <div><b>M√£:</b> ${get('code','ma','id')}</div>
        <div><b>T√™n t√°c v·ª•:</b> ${get('title','name')}</div>
        <div><b>Ng∆∞·ªùi y√™u c·∫ßu:</b> ${get('requesterName','requester','nguoiyc')}</div>
        <div><b>Ph√≤ng ban y√™u c·∫ßu:</b> ${get('requesterDept','dept','phongban')}</div>
        <div><b>Ng∆∞·ªùi nh·∫≠n m·∫´u:</b> ${get('receiverName','receiver','nguoinhan')}</div>
        <div><b>Form ƒë√°nh gi√°:</b> ${get('formName','form')}</div>
        <div><b>C√¥ng chu·∫©n:</b> ${get('manhour','congchuan')}</div>
        <div><b>Ng√†y y√™u c·∫ßu:</b> ${fmtDmy(get('requestDate','ngayyeucau','ngay_yeu_cau'))}</div>
        <div><b>H·∫°n mong mu·ªën:</b> ${fmtDmy(get('wishDate','wish'))}</div>
        <div class="md:col-span-2"><b>M·ª•c ƒë√≠ch ƒë√°nh gi√°:</b> ${get('purpose','mucdich')}</div>
        <div class="md:col-span-2"><b>Note:</b> ${get('note')}</div>
        <div class="md:col-span-2"><b>Y√™u c·∫ßu test ƒë·∫∑c bi·ªát:</b> ${get('specialTest','yeucautest')}</div>
      </div>`;

      if (openNew){ openNew.href = url||'#'; openNew.style.pointerEvents = url? '':'none'; openNew.style.opacity = url? '1':'0.5'; }
      if (content) content.innerHTML = detailHtml;
      openModal(modalId);
    }

    async function openReportPreview(id){
      const modalId = 'modal-report'; const frame = document.getElementById('report-frame'); const titleEl = document.getElementById('report-title'); const openNew = document.getElementById('report-open-new');
      const it = findItem(id); if (titleEl) titleEl.textContent = it ? `${it.code} ‚Äî ${it.title}` : String(id||'');
      let url = '';
      {
        const it = findItem(id);
        url = it?.reportUrl || '';
        if (!url){
          const headerMapDetail = { header_reportUrl: 'Li√™n k·∫øt b√°o c√°o', field_reportUrl: 'reportUrl' };
          const qs = new URLSearchParams({ action:'report_detail', ...headerMapDetail, id:String(id), _ts: Date.now().toString() });
          async function fetchJson(u){ const r=await fetch(`${u}?${qs.toString()}`, { method:'GET' }); const t=await r.text(); let j=null; try{ j=JSON.parse(t);}catch{} return { ok:r.ok, parsed:j, raw:t, status:r.status }; }
          function pickUrl(j){ if(!j) return ''; const cands=['url','reportUrl','link','file','href']; for(const k of cands){ const v=j[k]||j[k.toLowerCase?.()]||undefined; if (typeof v==='string' && v) return v; } try{ const q=[j]; const seen=new Set(); while(q.length){ const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue; seen.add(cur); for(const [k,v] of Object.entries(cur)){ if (typeof v==='string' && /https?:\/\//i.test(v)) return v; if (v && typeof v==='object') q.push(v); } } }catch(_){} return ''; }
          let resp = await fetchJson(WEBHOOK_DETAIL);
          url = pickUrl(resp.parsed ?? (resp.raw? JSON.parse(resp.raw): null)) || '';
        }
      }
      if (openNew) { openNew.href = url || '#'; openNew.style.pointerEvents = url ? '' : 'none'; openNew.style.opacity = url ? '1' : '0.5'; }
      if (frame) frame.src = url || 'about:blank';
      openModal(modalId);
    }

    async function doApprove(){
      const btn = document.getElementById('approve-do'); if (!CURRENT_ITEM_ID || !btn) return;
      const prev = btn.textContent; btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const comment = (document.getElementById('approve-comment')?.value||'').trim();
      const qaCode = generateQaPdCode();
      try{
          // Chuy·ªÉn tr·∫°ng th√°i t·ª´ Pending1 -> Pending2 cho tr∆∞·ªüng ph√≤ng x·ª≠ l√Ω, k√®m reviewer
          function normCode(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase(); }
          const codeInput = normCode(document.getElementById('secret-code')?.value||'');
          // M√£ b·∫£o m·∫≠t b·∫Øt bu·ªôc ƒë·ªÉ thao t√°c duy·ªát
          if (!codeInput){ throw new Error('Vui l√≤ng nh·∫≠p m√£ b·∫£o m·∫≠t tr∆∞·ªõc khi duy·ªát.'); }
          // Map m√£ duy·ªát -> t√™n ƒë·∫ßy ƒë·ªß n·∫øu c·∫ßn
          const CODE_TO_NAME = { 'nguyenvanlinh':'Nguy·ªÖn VƒÉn Linh', 'nguyenvanhieu':'Nguy·ªÖn VƒÉn Hi·∫øu', 'linh':'Nguy·ªÖn VƒÉn Linh', 'hieu':'Nguy·ªÖn VƒÉn Hi·∫øu' };
          const reviewer = codeInput; // g·ª≠i m√£ duy·ªát (kh√¥ng d·∫•u) l√™n server
          const p = new URLSearchParams({ action:'report_approve', id:String(CURRENT_ITEM_ID), reviewer, comment, next_status:'Pending2', qa_code: qaCode, _ts: Date.now().toString() });
          // ƒê√≠nh k√®m to√†n b·ªô d·ªØ li·ªáu d√≤ng v√† th·ªùi gian ph√∫t
          try{ const it = findItem(CURRENT_ITEM_ID); appendRowParams(p, it); }catch(_){ }
          async function tryPost(url){ try{ const r=await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString(), cache:'no-store' }); const t=await r.text(); return { ok:r.ok, raw:t }; }catch(err){ return { ok:false, raw:String(err||'') }; } }
          // B·ªè GET v√† no-cors ƒë·ªÉ tr√°nh nh·∫ßm endpoint; c·ªë g·∫Øng POST 2 l·∫ßn
          let r = await tryPost(APPROVE_URL);
          if (!r.ok) r = await tryPost(APPROVE_URL);
          if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
        closeModal('modal-approve'); showToast(`ƒê√£ duy·ªát b√°o c√°o. M√£: ${qaCode}`,'success');
        await reload();
      }catch(err){ showToast('L·ªói duy·ªát b√°o c√°o.','error'); }
      finally{ btn.disabled=false; btn.textContent = prev||'X√°c nh·∫≠n duy·ªát'; }
    }

    async function doReject(){
      const btn = document.getElementById('reject-do'); if (!CURRENT_ITEM_ID || !btn) return;
      const prev = btn.textContent; btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const reason = (document.getElementById('reject-reason')?.value||'').trim();
      if (!reason){ showToast('Vui l√≤ng nh·∫≠p l√Ω do.','error'); btn.disabled=false; btn.textContent=prev; return; }
      const qaCode = generateQaPdCode();
      try{
          const p = new URLSearchParams({ action:'report_reject', id:String(CURRENT_ITEM_ID), reviewer: (document.getElementById('secret-code')?.value||'').trim(), reason, qa_code: qaCode, _ts: Date.now().toString() });
          try{ const it = findItem(CURRENT_ITEM_ID); appendRowParams(p, it); }catch(_){ }
          async function tryPost(url){ try{ const r=await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString(), cache:'no-store' }); const t=await r.text(); return { ok:r.ok, raw:t }; }catch(err){ return { ok:false, raw:String(err||'') }; } }
          let r = await tryPost(APPROVE_URL);
          if (!r.ok) r = await tryPost(APPROVE_URL);
          if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
        closeModal('modal-reject'); showToast(`ƒê√£ t·ª´ ch·ªëi. M√£: ${qaCode}`,'success');
        await reload();
      }catch(err){ showToast('L·ªói t·ª´ ch·ªëi.','error'); }
      finally{ btn.disabled=false; btn.textContent = prev||'X√°c nh·∫≠n t·ª´ ch·ªëi'; }
    }

    async function doRequest(){
      const btn = document.getElementById('req-do'); if (!CURRENT_ITEM_ID || !btn) return;
      const prev = btn.textContent; btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const comment = (document.getElementById('req-comment')?.value||'').trim();
      const dueDate = (document.getElementById('req-due')?.value||'').trim();
      const qaCode = generateQaPdCode();
      try{
          const p = new URLSearchParams({ action:'report_request_changes', id:String(CURRENT_ITEM_ID), reviewer: (document.getElementById('secret-code')?.value||'').trim(), comment, dueDate, qa_code: qaCode, _ts: Date.now().toString() });
          try{ const it = findItem(CURRENT_ITEM_ID); appendRowParams(p, it); }catch(_){ }
          async function tryPost(url){ try{ const r=await fetch(url, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p.toString(), cache:'no-store' }); const t=await r.text(); return { ok:r.ok, raw:t }; }catch(err){ return { ok:false, raw:String(err||'') }; } }
          let r = await tryPost(APPROVE_URL);
          if (!r.ok) r = await tryPost(APPROVE_URL);
          if (!r.ok) throw new Error(r.raw||'G·ª≠i th·∫•t b·∫°i');
        closeModal('modal-req'); showToast(`ƒê√£ y√™u c·∫ßu b·ªï sung. M√£: ${qaCode}`,'success');
        await reload();
      }catch(err){ showToast('L·ªói g·ª≠i y√™u c·∫ßu.','error'); }
      finally{ btn.disabled=false; btn.textContent = prev||'G·ª≠i y√™u c·∫ßu'; }
    }

    // ===== Ph√™ duy·ªát Form Functions
    async function fetchPdFormData(){
      try{
        async function fetchJson(url){
          const r = await fetch(url, { method:'GET' });
          const t = await r.text();
          let parsed = null;
          try{ parsed = JSON.parse(t); }catch(_){}
          return { ok:r.ok, parsed, raw:t, status:r.status };
        }
        function safeParse(txt){ try{ return JSON.parse(txt); }catch(_){ return null; } }
        function collectRowsDeep(json){
          if(!json) return [];
          if(Array.isArray(json)) return json;
          const out=[]; const seen=new Set(); const q=[json];
          try{
            while(q.length){
              const cur=q.shift(); if(!cur||typeof cur!=='object'||seen.has(cur)) continue;
              seen.add(cur);
              for(const v of Object.values(cur)){
                if(Array.isArray(v)){
                  if(v.length && typeof v[0]==='object') out.push(...v);
                  v.forEach(x=>{ if(x && typeof x==='object') q.push(x); });
                  continue;
                }
                if(v && typeof v==='object') q.push(v);
              }
            }
          }catch(_){}
          return out.length ? out : (typeof json==='object' ? [json] : []);
        }
        const qs = new URLSearchParams({ _ts: Date.now().toString() });
        let resp = await fetchJson(`${PDFORM_QUERY_URL}?${qs.toString()}`);
        if (!resp.ok || /could not be started/i.test(String(resp.parsed?.message||''))) resp = await fetchJson(`${PDFORM_QUERY_URL.replace('/webhook-test/','/webhook/')}?${qs.toString()}`);
        if (!resp.ok) return [];
        const baseJson = resp.parsed ?? safeParse(resp.raw);
        const rows = collectRowsDeep(baseJson);
        function lowerKeyMap(obj){ const map={}; try{ Object.keys(obj||{}).forEach(k=>{ map[String(k).toLowerCase()] = obj[k]; }); }catch(_){ } return map; }
        function getFrom(lowerObj, ...keys){ for(const k of keys){ const kk=String(k||'').toLowerCase(); if (lowerObj.hasOwnProperty(kk)) return lowerObj[kk]; } return ''; }
        return rows.map(x=>{
          const lx = lowerKeyMap(x||{});
          // L·∫•y d·ªØ li·ªáu Subtask (hi·ªÉn th·ªã tr√™n b·∫£ng)
          const subtaskName = getFrom(lx,'subtaskname','SubtaskName') || '';
          const subtaskPIC = getFrom(lx,'subtaskpic','SubtaskPIC') || '';
          const subtaskStatus = getFrom(lx,'subtaskstatus','Subtaskstatus') || '';
          const subtaskTimeSend = getFrom(lx,'subtasktimesend','Subtasktimesend') || '';
          const subtaskFormLink = getFrom(lx,'subtaskformlink','Subtaskformlink') || '';
          const subtaskCode = getFrom(lx,'subtaskcode','Subtaskcode') || '';
          const subtaskItemCode = getFrom(lx,'subtaskitemcode','Subtaskitemcode') || '';
          const subtaskNote = getFrom(lx,'subtasknote','Subtasknote') || '';
          const parentId = getFrom(lx,'parent_id','parentid') || '';
          const taskRequestCode = getFrom(lx,'taskrequestcode','TaskRequestCode') || '';
          
          // L∆∞u to√†n b·ªô d·ªØ li·ªáu Task ƒë·ªÉ hi·ªÉn th·ªã trong modal
          const taskData = {};
          Object.keys(x||{}).forEach(key => {
            if (key.startsWith('Task') || key === 'Id' || key === 'CreatedAt' || key === 'UpdatedAt' || 
                key === 'type' || key === 'project_code' || key === 'parent_id') {
              taskData[key] = x[key];
            }
          });
          
          return {
            id: getFrom(lx,'id','ID','Id') || '',
            // D·ªØ li·ªáu Subtask cho b·∫£ng
            subtaskName: subtaskName,
            subtaskPIC: subtaskPIC,
            subtaskStatus: subtaskStatus,
            subtaskTimeSend: subtaskTimeSend,
            subtaskFormLink: subtaskFormLink,
            subtaskCode: subtaskCode,
            subtaskItemCode: subtaskItemCode,
            subtaskNote: subtaskNote,
            maTacVu: parentId || taskRequestCode || '',
            // D·ªØ li·ªáu Task cho modal (l∆∞u to√†n b·ªô)
            taskData: taskData,
            rawData: x || {}
          };
        }).filter(r => r.id && (r.subtaskName || r.subtaskCode));
      }catch(err){
        console.error('Error fetching pdform data:', err);
        return [];
      }
    }
    function applyPdFormFilters(all){
      const statusFilter = (document.getElementById('pdform-flt-status')?.value || 'All');
      let filtered = all.filter(it=>{
        if (statusFilter === 'All') return true;
        const ketQua = String(it.subtaskStatus||'').trim();
        // Map c√°c gi√° tr·ªã c√≥ th·ªÉ c√≥
        if (statusFilter === 'Leader review') {
          return ketQua === 'Leader review' || ketQua === 'leader review';
        }
        if (statusFilter === 'Ch·ªù TP ph√™ duy·ªát') {
          return ketQua === 'Ch·ªù TP ph√™ duy·ªát' || ketQua === 'Ch·ªù ph√™ duy·ªát form' || ketQua === 'ch·ªù tp ph√™ duy·ªát';
        }
        if (statusFilter === 'ƒê∆∞·ª£c duy·ªát') {
          return ketQua === 'ƒê∆∞·ª£c duy·ªát' || ketQua === 'ƒê√£ ph√™ duy·ªát' || ketQua === 'ƒë∆∞·ª£c duy·ªát';
        }
        return ketQua === statusFilter;
      });
      // S·∫Øp x·∫øp theo th·ªùi gian g·ª≠i t·ª´ g·∫ßn ƒë·∫øn xa (m·ªõi nh·∫•t tr∆∞·ªõc)
      filtered.sort((a, b) => {
        const parseTime = (timeStr) => {
          if (!timeStr) return 0;
          try {
            const match = String(timeStr).trim().match(/(\d{4})-(\d{2})-(\d{2})[\sT](\d{2}):(\d{2})/);
            if (match) {
              const [, yyyy, mm, dd, hh, min] = match;
              return new Date(yyyy, parseInt(mm)-1, dd, hh, min).getTime();
            }
            // Th·ª≠ parse tr·ª±c ti·∫øp
            const d = new Date(timeStr);
            return isNaN(d.getTime()) ? 0 : d.getTime();
          } catch(e) {
            return 0;
          }
        };
        const timeA = parseTime(a.subtaskTimeSend);
        const timeB = parseTime(b.subtaskTimeSend);
        // S·∫Øp x·∫øp t·ª´ m·ªõi ƒë·∫øn c≈© (timeB - timeA)
        return timeB - timeA;
      });
      return filtered;
    }
    function updatePdFormPager(total){
      const pager = document.getElementById('pdform-pager');
      const info = document.getElementById('pdform-page-info');
      const ps = PDFORM_PAGE_SIZE;
      const pages = Math.max(1, Math.ceil(total/ps));
      if (PDFORM_PAGE > pages) PDFORM_PAGE = pages;
      if (info) info.textContent = `Trang ${PDFORM_PAGE}/${pages} (${total} d√≤ng)`;
      if (pager) pager.style.display = total>0 ? 'flex' : 'none';
    }
    function renderPdFormTable(){
      const body = document.getElementById('pdform-list-body');
      if (!body) return;
      const total = PDFORM_FILTERED.length;
      updatePdFormPager(total);
      if (!total){
        body.innerHTML = '<tr><td class="px-3 py-3 text-center text-gray-500" colspan="9">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
        return;
      }
      const start = (PDFORM_PAGE-1)*PDFORM_PAGE_SIZE;
      const end = Math.min(total, start+PDFORM_PAGE_SIZE);
      const pageItems = PDFORM_FILTERED.slice(start,end);
      body.innerHTML = pageItems.map(it=>{
        const statusBadge = ({
          'Ch·ªù ph√™ duy·ªát form': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-200">Ch·ªù ph√™ duy·ªát form</span>',
          'Leader review': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-200">Leader review</span>',
          'ƒê√£ ph√™ duy·ªát': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-200">ƒê√£ ph√™ duy·ªát</span>',
          'ƒê∆∞·ª£c duy·ªát': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-green-50 text-green-700 border border-green-200">ƒê∆∞·ª£c duy·ªát</span>',
          'T·ª´ ch·ªëi': '<span class="px-2 py-1 rounded-full text-xs font-semibold bg-red-50 text-red-700 border border-red-200">T·ª´ ch·ªëi</span>'
        })[String(it.subtaskStatus||'')] || `<span class="px-2 py-1 rounded-full text-xs font-semibold bg-gray-50 text-gray-700 border border-gray-200">${escapeHtml(String(it.subtaskStatus||''))}</span>`;
        // Format th·ªùi gian g·ª≠i: "2025-11-25 09:46:00+00:00" -> "25/11/2025 09:46"
        let sendTimeDisplay = '';
        if (it.subtaskTimeSend) {
          try {
            const timeStr = String(it.subtaskTimeSend).trim();
            // X·ª≠ l√Ω format "2025-11-25 09:46:00+00:00" ho·∫∑c "2025-11-25T09:46"
            const match = timeStr.match(/(\d{4})-(\d{2})-(\d{2})[\sT](\d{2}):(\d{2})/);
            if (match) {
              sendTimeDisplay = `${match[3]}/${match[2]}/${match[1]} ${match[4]}:${match[5]}`;
            } else {
              sendTimeDisplay = timeStr;
            }
          } catch(e) {
            sendTimeDisplay = it.subtaskTimeSend;
          }
        }
        // Ki·ªÉm tra tr·∫°ng th√°i ƒë·ªÉ enable/disable n√∫t
        const canApprove = String(it.subtaskStatus||'') === 'Leader review';
        const disabled = canApprove ? '' : 'opacity-50 pointer-events-none';
        // Link form b√°o c√°o - ki·ªÉm tra v√† hi·ªÉn th·ªã Subtaskformlink
        let formLink = '<span class="text-gray-400">-</span>';
        const formLinkValue = String(it.subtaskFormLink || '').trim();
        if (formLinkValue && formLinkValue !== 'null' && formLinkValue !== 'undefined') {
          // ƒê·∫£m b·∫£o URL c√≥ protocol
          let url = formLinkValue;
          if (!url.match(/^https?:\/\//i)) {
            url = 'https://' + url;
          }
          formLink = `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="text-blue-700 underline hover:text-blue-900">Xem form</a>`;
        }
        // M√£ hi·ªÉn th·ªã: ∆∞u ti√™n Subtaskcode, n·∫øu kh√¥ng c√≥ th√¨ d√πng Subtaskitemcode
        const maDisplay = it.subtaskCode || it.subtaskItemCode || '';
        return `
          <tr>
            <td class="px-3 py-2">
              <div class="flex items-center gap-2">
                <button class="px-3 py-1 rounded-full text-white font-semibold bg-primary-blue hover:brightness-105 pdform-approve-btn ${disabled}" data-id="${it.id}">Duy·ªát</button>
                <button class="px-3 py-1 rounded-full text-white font-semibold pdform-reject-btn ${disabled}" style="background:#ef4444" data-id="${it.id}">T·ª´ ch·ªëi</button>
              </div>
            </td>
            <td class="px-3 py-2">${escapeHtml(it.subtaskName || '')}</td>
            <td class="px-3 py-2">${escapeHtml(maDisplay)}</td>
            <td class="px-3 py-2"><a href="#" class="text-blue-700 hover:underline">${escapeHtml(it.maTacVu || '')}</a></td>
            <td class="px-3 py-2">${escapeHtml(it.subtaskPIC || '')}</td>
            <td class="px-3 py-2">${statusBadge}</td>
            <td class="px-3 py-2">${sendTimeDisplay}</td>
            <td class="px-3 py-2">${formLink}</td>
            <td class="px-3 py-2">
              <button class="px-3 py-1 rounded-lg text-white font-semibold bg-primary-blue hover:brightness-105 pdform-detail-btn" data-id="${it.id}">Chi ti·∫øt</button>
            </td>
          </tr>`;
      }).join('');
    }
    async function openPdFormDetail(id){
      const modalId = 'modal-form-detail';
      const titleEl = document.getElementById('form-detail-title');
      const contentEl = document.getElementById('form-detail-content');
      const item = PDFORM_ITEMS.find(x => String(x.id) === String(id));
      if (!item){
        if (contentEl) contentEl.innerHTML = '<div class="text-red-600">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</div>';
        openModal(modalId);
        return;
      }
      // L·∫•y th√¥ng tin Task t·ª´ taskData
      const taskData = item.taskData || {};
      const taskRequestCode = taskData.TaskRequestCode || taskData.parent_id || '';
      const taskItemName = taskData.TaskItemName || '';
      if (titleEl) titleEl.textContent = `${taskRequestCode} - ${taskItemName}`;
      if (contentEl) contentEl.innerHTML = '<div class="spinner mx-auto mb-2"></div><p class="text-gray-600 text-center">ƒêang t·∫£i...</p>';
      openModal(modalId);
      try{
        let html = '<div class="space-y-4">';
        // Th√¥ng tin Task
        html += '<div class="bg-blue-50 p-4 rounded-lg"><h4 class="font-semibold text-blue-800 mb-3">Th√¥ng tin Task</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">';
        
        // Hi·ªÉn th·ªã t·∫•t c·∫£ c√°c tr∆∞·ªùng Task t·ª´ taskData
        if (taskData.Id) html += `<div><span class="font-medium">ID:</span> <span class="text-gray-700">${escapeHtml(String(taskData.Id))}</span></div>`;
        if (taskData.TaskRequestCode) html += `<div><span class="font-medium">M√£ y√™u c·∫ßu:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskRequestCode))}</span></div>`;
        if (taskData.TaskRequesterName) html += `<div><span class="font-medium">Ng∆∞·ªùi y√™u c·∫ßu:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskRequesterName))}</span></div>`;
        if (taskData.TaskRequesterEmail) html += `<div><span class="font-medium">Email:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskRequesterEmail))}</span></div>`;
        if (taskData.TaskRequestDate) html += `<div><span class="font-medium">Ng√†y y√™u c·∫ßu:</span> <span class="text-gray-700">${fmtDmy(String(taskData.TaskRequestDate))}</span></div>`;
        if (taskData.TaskDeptRequest) html += `<div><span class="font-medium">Ph√≤ng ban y√™u c·∫ßu:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskDeptRequest))}</span></div>`;
        if (taskData.TaskItemName) html += `<div><span class="font-medium">T√™n s·∫£n ph·∫©m:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskItemName))}</span></div>`;
        if (taskData.TaskItemCode) html += `<div><span class="font-medium">M√£ s·∫£n ph·∫©m:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskItemCode))}</span></div>`;
        if (taskData.TaskComponentType) html += `<div><span class="font-medium">Lo·∫°i linh ki·ªán:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskComponentType))}</span></div>`;
        if (taskData.TaskComponentStandard) html += `<div><span class="font-medium">Ti√™u chu·∫©n linh ki·ªán:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskComponentStandard))}</span></div>`;
        if (taskData.TaskPurpose) html += `<div class="md:col-span-2"><span class="font-medium">M·ª•c ƒë√≠ch ƒë√°nh gi√°:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskPurpose))}</span></div>`;
        if (taskData.TaskVendor) html += `<div><span class="font-medium">Nh√† cung c·∫•p:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskVendor))}</span></div>`;
        if (taskData.TaskQtySamples) html += `<div><span class="font-medium">S·ªë l∆∞·ª£ng m·∫´u:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskQtySamples))}</span></div>`;
        if (taskData.TaskDesiredDate) html += `<div><span class="font-medium">H·∫°n mong mu·ªën:</span> <span class="text-gray-700">${fmtDmy(String(taskData.TaskDesiredDate))}</span></div>`;
        if (taskData.TaskPersonReceived) html += `<div><span class="font-medium">Ng∆∞·ªùi nh·∫≠n m·∫´u:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskPersonReceived))}</span></div>`;
        if (taskData.TaskNotes) html += `<div class="md:col-span-2"><span class="font-medium">Ghi ch√∫:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskNotes))}</span></div>`;
        if (taskData.TaskChangeFromLastNote) html += `<div class="md:col-span-2"><span class="font-medium">Thay ƒë·ªïi t·ª´ l·∫ßn tr∆∞·ªõc:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskChangeFromLastNote))}</span></div>`;
        if (taskData.TaskSampleSubmissionNo) html += `<div><span class="font-medium">S·ªë l·∫ßn n·ªôp m·∫´u:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskSampleSubmissionNo))}</span></div>`;
        if (taskData.TaskAltCode) html += `<div><span class="font-medium">M√£ thay th·∫ø:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskAltCode))}</span></div>`;
        if (taskData.TaskAppliedModel) html += `<div class="md:col-span-2"><span class="font-medium">Model √°p d·ª•ng:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskAppliedModel))}</span></div>`;
        if (taskData.TaskAttachments) html += `<div class="md:col-span-2"><span class="font-medium">File ƒë√≠nh k√®m:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskAttachments))}</span></div>`;
        if (taskData.TaskDescription) html += `<div class="md:col-span-2"><span class="font-medium">M√¥ t·∫£:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskDescription))}</span></div>`;
        if (taskData.TaskPIC) html += `<div><span class="font-medium">PIC:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskPIC))}</span></div>`;
        if (taskData.TaskDepartment) html += `<div><span class="font-medium">Ph√≤ng ban:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskDepartment))}</span></div>`;
        if (taskData.TaskCreatedAt) html += `<div><span class="font-medium">Ng√†y t·∫°o:</span> <span class="text-gray-700">${fmtDmy(String(taskData.TaskCreatedAt))}</span></div>`;
        if (taskData.TaskDueDate) html += `<div><span class="font-medium">H·∫°n ƒë√°nh gi√°:</span> <span class="text-gray-700">${fmtDmy(String(taskData.TaskDueDate))}</span></div>`;
        if (taskData.TaskStatus) html += `<div><span class="font-medium">Tr·∫°ng th√°i:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskStatus))}</span></div>`;
        if (taskData.TaskPriority) html += `<div><span class="font-medium">∆Øu ti√™n:</span> <span class="text-gray-700">${escapeHtml(String(taskData.TaskPriority))}</span></div>`;
        if (taskData.project_code) html += `<div><span class="font-medium">M√£ d·ª± √°n:</span> <span class="text-gray-700">${escapeHtml(String(taskData.project_code))}</span></div>`;
        if (taskData.parent_id) html += `<div><span class="font-medium">M√£ t√°c v·ª• cha:</span> <span class="text-gray-700">${escapeHtml(String(taskData.parent_id))}</span></div>`;
        if (taskData.CreatedAt) {
          const createdDate = fmtDmy(String(taskData.CreatedAt));
          if (createdDate) html += `<div><span class="font-medium">Ng√†y t·∫°o (CreatedAt):</span> <span class="text-gray-700">${createdDate}</span></div>`;
        }
        if (taskData.UpdatedAt) {
          const updatedDate = fmtDmy(String(taskData.UpdatedAt));
          if (updatedDate) html += `<div><span class="font-medium">Ng√†y c·∫≠p nh·∫≠t:</span> <span class="text-gray-700">${updatedDate}</span></div>`;
        }
        
        html += '</div></div>';
        
        // Th√¥ng tin Subtask (n·∫øu c·∫ßn hi·ªÉn th·ªã)
        html += '<div class="bg-green-50 p-4 rounded-lg"><h4 class="font-semibold text-green-800 mb-3">Th√¥ng tin Subtask</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">';
        if (item.subtaskName) html += `<div><span class="font-medium">T√™n subtask:</span> <span class="text-gray-700">${escapeHtml(item.subtaskName)}</span></div>`;
        if (item.subtaskPIC) html += `<div><span class="font-medium">PIC subtask:</span> <span class="text-gray-700">${escapeHtml(item.subtaskPIC)}</span></div>`;
        if (item.subtaskCode) html += `<div><span class="font-medium">M√£ subtask:</span> <span class="text-gray-700">${escapeHtml(item.subtaskCode)}</span></div>`;
        if (item.subtaskItemCode) html += `<div><span class="font-medium">M√£ s·∫£n ph·∫©m subtask:</span> <span class="text-gray-700">${escapeHtml(item.subtaskItemCode)}</span></div>`;
        if (item.subtaskStatus) html += `<div><span class="font-medium">Tr·∫°ng th√°i:</span> <span class="text-gray-700">${escapeHtml(item.subtaskStatus)}</span></div>`;
        if (item.subtaskTimeSend) {
          const sendTimeDisplay = fmtDmy(item.subtaskTimeSend);
          if (sendTimeDisplay) html += `<div><span class="font-medium">Th·ªùi gian g·ª≠i:</span> <span class="text-gray-700">${sendTimeDisplay}</span></div>`;
        }
        if (item.subtaskNote) html += `<div class="md:col-span-2"><span class="font-medium">Ghi ch√∫:</span> <span class="text-gray-700">${escapeHtml(item.subtaskNote)}</span></div>`;
        if (item.subtaskFormLink) {
          let url = String(item.subtaskFormLink).trim();
          if (url && url !== 'null' && url !== 'undefined') {
            if (!url.match(/^https?:\/\//i)) {
              url = 'https://' + url;
            }
            html += `<div class="md:col-span-2"><span class="font-medium">Link form:</span> <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer" class="text-blue-700 underline">Xem form</a></div>`;
          }
        }
        html += '</div></div>';
        
        html += '</div>';
        if (contentEl) contentEl.innerHTML = html;
      }catch(err){
        console.error('Error loading form detail:', err);
        if (contentEl) contentEl.innerHTML = '<div class="text-red-600">L·ªói x·ª≠ l√Ω d·ªØ li·ªáu: ' + err.message + '</div>';
      }
    }
    async function reloadPdForm(){
      const btn = document.getElementById('pdform-btn-search');
      const prev = btn ? btn.textContent : '';
      if (btn){ btn.disabled = true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i..."; }
      try{
        const items = await fetchPdFormData();
        PDFORM_ITEMS = Array.isArray(items) ? items : [];
        PDFORM_FILTERED = applyPdFormFilters(PDFORM_ITEMS);
        PDFORM_PAGE = 1;
        renderPdFormTable();
      }catch(err){
        showToast('L·ªói t·∫£i d·ªØ li·ªáu.','error');
        console.error('Error reloading pdform:', err);
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = prev || 'T·∫£i l·∫°i'; }
      }
    }
    function openPdFormApproveModal(id){
      CURRENT_PDFORM_ID = id;
      const commentEl = document.getElementById('pdform-approve-comment');
      if (commentEl) commentEl.value = '';
      openModal('modal-pdform-approve');
    }
    function openPdFormRejectModal(id){
      CURRENT_PDFORM_ID = id;
      const reasonEl = document.getElementById('pdform-reject-reason');
      if (reasonEl) reasonEl.value = '';
      openModal('modal-pdform-reject');
    }
    async function doPdFormApprove(){
      const btn = document.getElementById('pdform-approve-do');
      if (!CURRENT_PDFORM_ID || !btn) return;
      const prev = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const comment = (document.getElementById('pdform-approve-comment')?.value||'').trim();
      // L·∫•y m·∫≠t m√£ t·ª´ input secret-code
      function normCode(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase(); }
      const codeInput = normCode(document.getElementById('secret-code')?.value||'');
      // M√£ b·∫£o m·∫≠t b·∫Øt bu·ªôc ƒë·ªÉ thao t√°c duy·ªát
      if (!codeInput){ 
        showToast('Vui l√≤ng nh·∫≠p m√£ b·∫£o m·∫≠t tr∆∞·ªõc khi duy·ªát.','error');
        btn.disabled = false;
        btn.textContent = prev || 'X√°c nh·∫≠n duy·ªát';
        return;
      }
      const reviewer = codeInput; // g·ª≠i m√£ duy·ªát (kh√¥ng d·∫•u) l√™n server
      // T√¨m item trong danh s√°ch ƒë·ªÉ l·∫•y to√†n b·ªô d·ªØ li·ªáu
      const item = PDFORM_ITEMS.find(it => String(it.id) === String(CURRENT_PDFORM_ID));
      const fullData = item?.rawData || {};
      // T·∫°o th·ªùi gian Leaderformactiontime: YYYY-MM-DD HH:mm
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const leaderFormActionTime = `${yyyy}-${mm}-${dd} ${hh}:${min}`;
      try{
        // G·ª≠i to√†n b·ªô d·ªØ li·ªáu c·ªßa t√°c v·ª• (lo·∫°i b·ªè Taskdata)
        const p = new URLSearchParams();
        // ƒê·∫∑t action tr∆∞·ªõc ti√™n ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã ghi ƒë√®
        p.append('action', 'pdform_approve');
        p.append('id', String(CURRENT_PDFORM_ID));
        if (comment) p.append('comment', comment);
        p.append('reviewer', reviewer); // Th√™m m·∫≠t m√£ ng∆∞·ªùi duy·ªát
        p.append('Leaderformactiontime', leaderFormActionTime);
        p.append('_ts', Date.now().toString());
        // Th√™m t·∫•t c·∫£ c√°c tr∆∞·ªùng t·ª´ rawData v√†o params (tr√°nh ghi ƒë√® action, id, comment, reviewer, _ts v√† lo·∫°i b·ªè Taskdata)
        Object.keys(fullData).forEach(key => {
          const lowerKey = String(key).toLowerCase();
          // B·ªè qua c√°c tr∆∞·ªùng ƒë√£ ƒë∆∞·ª£c set tr∆∞·ªõc ƒë√≥ v√† Taskdata
          if (lowerKey === 'action' || lowerKey === 'id' || lowerKey === 'comment' || lowerKey === 'reviewer' || lowerKey === '_ts' || lowerKey === 'taskdata') {
            return;
          }
          const value = fullData[key];
          if (value !== null && value !== undefined) {
            // X·ª≠ l√Ω object/array b·∫±ng JSON.stringify, string/number th√¨ d√πng tr·ª±c ti·∫øp
            if (typeof value === 'object' && !Array.isArray(value)) {
              p.append(key, JSON.stringify(value));
            } else if (Array.isArray(value)) {
              p.append(key, JSON.stringify(value));
            } else {
              p.append(key, String(value));
            }
          }
        });
        // T·∫°o object payload ƒë·ªÉ g·ª≠i d∆∞·ªõi d·∫°ng JSON (lo·∫°i b·ªè Taskdata)
        const { Taskdata, ...dataWithoutTaskdata } = fullData;
        const payloadObj = {
          action: 'pdform_approve',
          id: String(CURRENT_PDFORM_ID),
          comment: comment || '',
          reviewer: reviewer, // Th√™m m·∫≠t m√£ ng∆∞·ªùi duy·ªát
          Leaderformactiontime: leaderFormActionTime,
          ...dataWithoutTaskdata
        };
        // Debug: log payload ƒë·ªÉ ki·ªÉm tra
        console.log('[doPdFormApprove] Payload object:', payloadObj);
        console.log('[doPdFormApprove] Action:', payloadObj.action);
        async function tryPostJson(url){
          try{
            const r = await fetch(url, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payloadObj)
            });
            const t = await r.text();
            return { ok: r.ok, raw: t, status: r.status };
          }catch(err){
            return { ok: false, raw: String(err||''), status: 0 };
          }
        }
        async function tryPost(url){
          try{
            const r = await fetch(url, {
              method: 'POST',
              headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              body: p.toString()
            });
            const t = await r.text();
            return { ok: r.ok, raw: t, status: r.status };
          }catch(err){
            return { ok: false, raw: String(err||''), status: 0 };
          }
        }
        async function tryPostNoCors(url){
          try{
            await fetch(url, {
              method: 'POST',
              mode: 'no-cors',
              headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              body: p.toString()
            });
            return { ok: true, raw: '' };
          }catch(err){
            return { ok: false, raw: String(err||'') };
          }
        }
        async function tryGet(url){
          try{
            const r = await fetch(`${url}?${p.toString()}`, { method: 'GET' });
            const t = await r.text();
            return { ok: r.ok, raw: t };
          }catch(err){
            return { ok: false, raw: String(err||'') };
          }
        }
        const ACTION_URL = PDFORM_ACTION_URL;
        // Th·ª≠ g·ª≠i d∆∞·ªõi d·∫°ng form-urlencoded tr∆∞·ªõc (kh√¥ng c·∫ßn preflight, tr√°nh CORS)
        let r = await tryPost(ACTION_URL);
        // N·∫øu form-urlencoded tr·∫£ v·ªÅ l·ªói, th·ª≠ JSON
        if (!r.ok && r.status !== 0) {
          console.log('[doPdFormApprove] Form-urlencoded failed (status:', r.status, '), trying JSON...');
          r = await tryPostJson(ACTION_URL);
        }
        // N·∫øu c·∫£ hai ƒë·ªÅu th·∫•t b·∫°i do CORS, th·ª≠ no-cors (kh√¥ng th·ªÉ ƒë·ªçc response nh∆∞ng c√≥ th·ªÉ g·ª≠i ƒë∆∞·ª£c)
        if (!r.ok && (r.status === 0 || r.status === 403 || r.status === 404)) {
          console.log('[doPdFormApprove] POST failed (CORS?), trying no-cors...');
          r = await tryPostNoCors(ACTION_URL);
          // no-cors lu√¥n tr·∫£ v·ªÅ ok:true nh∆∞ng kh√¥ng th·ªÉ ƒë·ªçc response
          if (r.ok) {
            console.log('[doPdFormApprove] No-cors request sent (cannot verify response)');
          }
        }
        if (!r.ok || /could not be started/i.test(r.raw||'')) {
          console.log('[doPdFormApprove] POST methods failed, trying GET...');
          r = await tryGet(ACTION_URL);
        }
        if (!r.ok) {
          const errorMsg = r.raw || `HTTP ${r.status || 'Unknown'}`;
          console.error('[doPdFormApprove] All methods failed:', errorMsg);
          throw new Error(errorMsg);
        }
        closeModal('modal-pdform-approve');
        showToast('ƒê√£ duy·ªát form th√†nh c√¥ng.','success');
        setTimeout(async () => {
          try{
            await reloadPdForm();
          }catch(reloadErr){
            console.error('L·ªói khi t·∫£i l·∫°i b·∫£ng:', reloadErr);
          }
        }, 500);
      }catch(err){
        showToast('L·ªói duy·ªát form.','error');
        console.error('Error approving form:', err);
      }finally{
        btn.disabled = false;
        btn.textContent = prev || 'X√°c nh·∫≠n duy·ªát';
      }
    }
    async function doPdFormReject(){
      const btn = document.getElementById('pdform-reject-do');
      if (!CURRENT_PDFORM_ID || !btn) return;
      const prev = btn.textContent;
      btn.disabled = true;
      btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang g·ª≠i...";
      const reason = (document.getElementById('pdform-reject-reason')?.value||'').trim();
      if (!reason){
        showToast('Vui l√≤ng nh·∫≠p l√Ω do.','error');
        btn.disabled = false;
        btn.textContent = prev;
        return;
      }
      // L·∫•y m·∫≠t m√£ t·ª´ input secret-code
      function normCode(s){ return String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase(); }
      const codeInput = normCode(document.getElementById('secret-code')?.value||'');
      // M√£ b·∫£o m·∫≠t b·∫Øt bu·ªôc ƒë·ªÉ thao t√°c t·ª´ ch·ªëi
      if (!codeInput){ 
        showToast('Vui l√≤ng nh·∫≠p m√£ b·∫£o m·∫≠t tr∆∞·ªõc khi t·ª´ ch·ªëi.','error');
        btn.disabled = false;
        btn.textContent = prev;
        return;
      }
      const reviewer = codeInput; // g·ª≠i m√£ duy·ªát (kh√¥ng d·∫•u) l√™n server
      // T√¨m item trong danh s√°ch ƒë·ªÉ l·∫•y to√†n b·ªô d·ªØ li·ªáu
      const item = PDFORM_ITEMS.find(it => String(it.id) === String(CURRENT_PDFORM_ID));
      const fullData = item?.rawData || {};
      // T·∫°o th·ªùi gian Leaderformactiontime: YYYY-MM-DD HH:mm
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, '0');
      const dd = String(now.getDate()).padStart(2, '0');
      const hh = String(now.getHours()).padStart(2, '0');
      const min = String(now.getMinutes()).padStart(2, '0');
      const leaderFormActionTime = `${yyyy}-${mm}-${dd} ${hh}:${min}`;
      try{
        // G·ª≠i to√†n b·ªô d·ªØ li·ªáu c·ªßa t√°c v·ª• (lo·∫°i b·ªè Taskdata)
        const p = new URLSearchParams();
        // ƒê·∫∑t action tr∆∞·ªõc ti√™n ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã ghi ƒë√®
        p.append('action', 'pdform_reject');
        p.append('id', String(CURRENT_PDFORM_ID));
        p.append('reason', reason);
        p.append('reviewer', reviewer); // Th√™m m·∫≠t m√£ ng∆∞·ªùi duy·ªát
        p.append('Leaderformactiontime', leaderFormActionTime);
        p.append('_ts', Date.now().toString());
        // Th√™m t·∫•t c·∫£ c√°c tr∆∞·ªùng t·ª´ rawData v√†o params (tr√°nh ghi ƒë√® action, id, reason, reviewer, _ts v√† lo·∫°i b·ªè Taskdata)
        Object.keys(fullData).forEach(key => {
          const lowerKey = String(key).toLowerCase();
          // B·ªè qua c√°c tr∆∞·ªùng ƒë√£ ƒë∆∞·ª£c set tr∆∞·ªõc ƒë√≥ v√† Taskdata
          if (lowerKey === 'action' || lowerKey === 'id' || lowerKey === 'reason' || lowerKey === 'reviewer' || lowerKey === '_ts' || lowerKey === 'taskdata') {
            return;
          }
          const value = fullData[key];
          if (value !== null && value !== undefined) {
            // X·ª≠ l√Ω object/array b·∫±ng JSON.stringify, string/number th√¨ d√πng tr·ª±c ti·∫øp
            if (typeof value === 'object' && !Array.isArray(value)) {
              p.append(key, JSON.stringify(value));
            } else if (Array.isArray(value)) {
              p.append(key, JSON.stringify(value));
            } else {
              p.append(key, String(value));
            }
          }
        });
        // T·∫°o object payload ƒë·ªÉ g·ª≠i d∆∞·ªõi d·∫°ng JSON (lo·∫°i b·ªè Taskdata)
        const { Taskdata, ...dataWithoutTaskdata } = fullData;
        const payloadObj = {
          action: 'pdform_reject',
          id: String(CURRENT_PDFORM_ID),
          reason: reason,
          reviewer: reviewer, // Th√™m m·∫≠t m√£ ng∆∞·ªùi duy·ªát
          Leaderformactiontime: leaderFormActionTime,
          ...dataWithoutTaskdata
        };
        // Debug: log payload ƒë·ªÉ ki·ªÉm tra
        console.log('[doPdFormReject] Payload object:', payloadObj);
        console.log('[doPdFormReject] Action:', payloadObj.action);
        async function tryPostJson(url){
          try{
            const r = await fetch(url, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'},
              body: JSON.stringify(payloadObj)
            });
            const t = await r.text();
            return { ok: r.ok, raw: t, status: r.status };
          }catch(err){
            return { ok: false, raw: String(err||''), status: 0 };
          }
        }
        async function tryPost(url){
          try{
            const r = await fetch(url, {
              method: 'POST',
              headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              body: p.toString()
            });
            const t = await r.text();
            return { ok: r.ok, raw: t, status: r.status };
          }catch(err){
            return { ok: false, raw: String(err||''), status: 0 };
          }
        }
        async function tryPostNoCors(url){
          try{
            await fetch(url, {
              method: 'POST',
              mode: 'no-cors',
              headers: {'Content-Type': 'application/x-www-form-urlencoded'},
              body: p.toString()
            });
            return { ok: true, raw: '' };
          }catch(err){
            return { ok: false, raw: String(err||'') };
          }
        }
        async function tryGet(url){
          try{
            const r = await fetch(`${url}?${p.toString()}`, { method: 'GET' });
            const t = await r.text();
            return { ok: r.ok, raw: t };
          }catch(err){
            return { ok: false, raw: String(err||'') };
          }
        }
        const ACTION_URL = PDFORM_ACTION_URL;
        // Th·ª≠ g·ª≠i d∆∞·ªõi d·∫°ng form-urlencoded tr∆∞·ªõc (kh√¥ng c·∫ßn preflight, tr√°nh CORS)
        let r = await tryPost(ACTION_URL);
        // N·∫øu form-urlencoded tr·∫£ v·ªÅ l·ªói, th·ª≠ JSON
        if (!r.ok && r.status !== 0) {
          console.log('[doPdFormReject] Form-urlencoded failed (status:', r.status, '), trying JSON...');
          r = await tryPostJson(ACTION_URL);
        }
        // N·∫øu c·∫£ hai ƒë·ªÅu th·∫•t b·∫°i do CORS, th·ª≠ no-cors (kh√¥ng th·ªÉ ƒë·ªçc response nh∆∞ng c√≥ th·ªÉ g·ª≠i ƒë∆∞·ª£c)
        if (!r.ok && (r.status === 0 || r.status === 403 || r.status === 404)) {
          console.log('[doPdFormReject] POST failed (CORS?), trying no-cors...');
          r = await tryPostNoCors(ACTION_URL);
          // no-cors lu√¥n tr·∫£ v·ªÅ ok:true nh∆∞ng kh√¥ng th·ªÉ ƒë·ªçc response
          if (r.ok) {
            console.log('[doPdFormReject] No-cors request sent (cannot verify response)');
          }
        }
        if (!r.ok || /could not be started/i.test(r.raw||'')) {
          console.log('[doPdFormReject] POST methods failed, trying GET...');
          r = await tryGet(ACTION_URL);
        }
        if (!r.ok) {
          const errorMsg = r.raw || `HTTP ${r.status || 'Unknown'}`;
          console.error('[doPdFormReject] All methods failed:', errorMsg);
          throw new Error(errorMsg);
        }
        closeModal('modal-pdform-reject');
        showToast('ƒê√£ t·ª´ ch·ªëi form.','success');
        setTimeout(async () => {
          try{
            await reloadPdForm();
          }catch(reloadErr){
            console.error('L·ªói khi t·∫£i l·∫°i b·∫£ng:', reloadErr);
          }
        }, 500);
      }catch(err){
        showToast('L·ªói t·ª´ ch·ªëi form.','error');
        console.error('Error rejecting form:', err);
      }finally{
        btn.disabled = false;
        btn.textContent = prev || 'X√°c nh·∫≠n t·ª´ ch·ªëi';
      }
    }

    // ===== Events & Init
    (function init(){
      // Close modal on backdrop click
      document.querySelectorAll('.modal').forEach(m=>{
        m.addEventListener('click', (e)=>{ if (e.target === m) closeModal(m.id); });
      });
      document.querySelectorAll('[data-close]').forEach(b=>{
        b.addEventListener('click', (e)=>{ e.preventDefault(); closeModal(b.getAttribute('data-close')||''); });
      });
      document.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ document.querySelectorAll('.modal.open').forEach(m=> closeModal(m.id)); } });

      // Toggle debug panel & kh√≥a trang theo m√£ b·∫£o m·∫≠t
      document.getElementById('btn-debug')?.addEventListener('click', (e)=>{
        e.preventDefault();
        const panel=document.getElementById('debug-panel'); if(!panel) return; panel.style.display = panel.style.display==='none' ? 'block' : 'none';
      });

      // Lock to√†n trang: y√™u c·∫ßu nh·∫≠p m√£ b·∫£o m·∫≠t tr∆∞·ªõc khi thao t√°c
      (function enforceSecretLock(){
        try{
          const input = document.getElementById('secret-code');
          const disableAll = (disabled)=>{
            document.querySelectorAll('button, input, select, textarea, a').forEach(el=>{
              if (el===input || el.id==='btn-debug') return; // v·∫´n cho nh·∫≠p m√£ v√† m·ªü debug
              if (disabled){ el.setAttribute('disabled','true'); el.classList.add('opacity-60','pointer-events-none'); }
              else { el.removeAttribute('disabled'); el.classList.remove('opacity-60','pointer-events-none'); }
            });
          };
          const update = ()=>{
            const raw = String(input?.value||'');
            const norm = raw.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').toLowerCase();
            const has = ['nguyenvanlinh','nguyenvanhieu'].includes(norm);
            disableAll(!has);
          };
          update();
          input?.addEventListener('input', ()=>{ update(); });
        }catch(_){ }
      })();

      // Group filter buttons
      document.querySelectorAll('.group-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          e.preventDefault();
          const group = btn.getAttribute('data-group');
          SELECTED_GROUP = group || 'all';
          document.querySelectorAll('.group-btn').forEach(b=> b.classList.remove('active'));
          btn.classList.add('active');
          // Kh√¥ng c√≤n dropdown ng∆∞·ªùi duy·ªát
          FILTERED = applyFilters(ALL_ITEMS);
          CURRENT_PAGE = 1;
          renderTable();
        });
      });

      const body = document.getElementById('list-body');
      body.addEventListener('click', (e)=>{
        const link = e.target.closest('.report-link');
        if (link){ e.preventDefault(); const rid=link.getAttribute('data-id'); if (rid) openReportPreview(rid); return; }
        const tLink = e.target.closest('.task-detail-link');
        if (tLink){ e.preventDefault(); const rid=tLink.getAttribute('data-id'); if (rid) openTaskDetail(rid); return; }
        const btn = e.target.closest('button'); if (!btn) return;
        const id = btn.getAttribute('data-id'); if (!id) return; CURRENT_ITEM_ID = id;
        if (btn.classList.contains('act-approve')){ CURRENT_ACTION='approve'; (document.getElementById('approve-comment')||{}).value=''; openModal('modal-approve'); return; }
        if (btn.classList.contains('act-reject')){ CURRENT_ACTION='reject'; (document.getElementById('reject-reason')||{}).value=''; openModal('modal-reject'); return; }
        if (btn.classList.contains('act-request')){ CURRENT_ACTION='request'; (document.getElementById('req-comment')||{}).value=''; (document.getElementById('req-due')||{}).value=''; openModal('modal-req'); return; }
      });

      document.getElementById('approve-do')?.addEventListener('click', (e)=>{ e.preventDefault(); doApprove(); });
      document.getElementById('reject-do')?.addEventListener('click', (e)=>{ e.preventDefault(); doReject(); });
      document.getElementById('req-do')?.addEventListener('click', (e)=>{ e.preventDefault(); doRequest(); });

      // Ph√™ duy·ªát Form events
      document.getElementById('pdform-btn-search')?.addEventListener('click', async (e)=>{ e.preventDefault(); await reloadPdForm(); });
      document.getElementById('pdform-flt-status')?.addEventListener('change', ()=>{ PDFORM_FILTERED = applyPdFormFilters(PDFORM_ITEMS); PDFORM_PAGE=1; renderPdFormTable(); });
      document.getElementById('pdform-page-size')?.addEventListener('change', (e)=>{ PDFORM_PAGE_SIZE = Number(e.target.value||20)||20; PDFORM_PAGE=1; renderPdFormTable(); });
      document.getElementById('pdform-prev')?.addEventListener('click', ()=>{ if (PDFORM_PAGE>1){ PDFORM_PAGE--; renderPdFormTable(); } });
      document.getElementById('pdform-next')?.addEventListener('click', ()=>{ const pages=Math.max(1,Math.ceil(PDFORM_FILTERED.length/PDFORM_PAGE_SIZE)); if (PDFORM_PAGE<pages){ PDFORM_PAGE++; renderPdFormTable(); } });
      
      // Ph√™ duy·ªát Form table event listener
      const pdformBody = document.getElementById('pdform-list-body');
      if (pdformBody) {
        pdformBody.addEventListener('click', (e)=>{
          const detailBtn = e.target.closest('.pdform-detail-btn');
          if (detailBtn){
            e.preventDefault();
            const id = detailBtn.getAttribute('data-id');
            if (id) openPdFormDetail(id);
            return;
          }
          const approveBtn = e.target.closest('.pdform-approve-btn');
          if (approveBtn && !approveBtn.classList.contains('opacity-50')){
            e.preventDefault();
            const id = approveBtn.getAttribute('data-id');
            if (id) openPdFormApproveModal(id);
            return;
          }
          const rejectBtn = e.target.closest('.pdform-reject-btn');
          if (rejectBtn && !rejectBtn.classList.contains('opacity-50')){
            e.preventDefault();
            const id = rejectBtn.getAttribute('data-id');
            if (id) openPdFormRejectModal(id);
            return;
          }
        });
      }
      // Modal buttons
      document.getElementById('pdform-approve-do')?.addEventListener('click', doPdFormApprove);
      document.getElementById('pdform-reject-do')?.addEventListener('click', doPdFormReject);

      document.getElementById('btn-search')?.addEventListener('click', async (e)=>{ e.preventDefault(); await reload(); });
      // Persist m√£ b·∫£o m·∫≠t
      try{
          const secCode = document.getElementById('secret-code');
          try{ localStorage.removeItem('tn_secret_code'); }catch(_){ }
          if (secCode){ secCode.value = ''; secCode.addEventListener('input', ()=>{ localStorage.setItem('tn_secret_code', secCode.value||''); }); }
          // Th√™m √¥ toggle hi·ªán/·∫©n m·∫≠t kh·∫©u
          const toggle = document.createElement('button');
          toggle.type = 'button';
          toggle.textContent = 'Hi·ªán';
          toggle.className = 'px-2 py-0.5 rounded border border-gray-300 bg-white hover:bg-gray-50';
          const headerRight = document.getElementById('btn-debug')?.parentElement;
          if (secCode && headerRight){ headerRight.insertBefore(toggle, document.getElementById('btn-debug')); }
          toggle?.addEventListener('click', ()=>{
            if (!secCode) return;
            const cur = secCode.getAttribute('type');
            secCode.setAttribute('type', cur==='password'?'text':'password');
            toggle.textContent = cur==='password'?'·∫®n':'Hi·ªán';
          });
        }catch(_){ }
      // Manual JSON loader: cho ph√©p d√°n JSON v√†o dbg-raw r·ªìi parse ƒë·ªÉ hi·ªÉn th·ªã
      document.getElementById('dbg-load-json')?.addEventListener('click', (e)=>{
        e.preventDefault();
        try{
          const t = document.getElementById('dbg-raw'); if(!t) return;
          const txt = t.value||''; if(!txt.trim()){ showToast('Kh√¥ng c√≥ JSON ƒë·ªÉ n·∫°p.','error'); return; }
          let j=null; try{ j=JSON.parse(txt); }catch(_){ showToast('JSON kh√¥ng h·ª£p l·ªá.','error'); return; }
          const rows = Array.isArray(j)? j: (Array.isArray(j?.data)? j.data: []);
          if (!rows.length){ showToast('JSON kh√¥ng c√≥ m·∫£ng d·ªØ li·ªáu.','error'); return; }
          // chu·∫©n h√≥a t·ªëi thi·ªÉu theo header map - h·ªó tr·ª£ c·∫£ key ti·∫øng Vi·ªát v√† ti·∫øng Anh
          ALL_ITEMS = rows.map(x=>{
            const statusRaw = String(x['K·∫øt qu·∫£']||x['Tr·∫°ng th√°i']||x['status']||'');
            const sNorm = statusRaw.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'');
            let status = 'Pending1';
            if (statusRaw.includes('Ch·ªù ph√™ duy·ªát 1') || statusRaw.toLowerCase().includes('cho phe duyet 1')) status = 'Pending1';
            else if (statusRaw.includes('Ch·ªù ph√™ duy·ªát 2') || statusRaw.includes('Tr∆∞·ªüng nh√≥m Review') || 
                     statusRaw.includes('Tr∆∞·ªùng nh√≥m Review') || sNorm === 'truongnhomreview') status = 'Pending2';
            else if (statusRaw.includes('Done') || statusRaw.includes('ƒê√£ duy·ªát')) status = 'Approved';
            return {
              id: String(x['Id']||x['ID']||x['id']||x['M√£ t√°c v·ª•']||x['M√£ b√°o c√°o']||''),
              code: String(x['M√£ t√°c v·ª•']||x['M√£ b√°o c√°o']||x['code']||x['Id']||x['ID']||''),
              title: String(x['Task Name']||x['Ti√™u ƒë·ªÅ']||x['title']||''),
              reporter: String(x['Assignee']||x['Ng∆∞·ªùi l·∫≠p']||x['reporter']||''),
              reporterEmail: String(x['Email']||x['reporterEmail']||''),
              submitDate: String(x['Ng√†y c·∫≠p nh·∫≠t g·∫ßn nh·∫•t']||x['Ng√†y n·ªôp']||x['submitDate']||''),
              wishDate: String(x['H·∫°n mong mu·ªën']||x['wishDate']||''),
              dueDate: String(x['Ng√†y ho√†n th√†nh th·ª±c t·∫ø']||x['H·∫°n ƒë√°nh gi√°']||x['dueDate']||''),
              status: status,
              conclusion: String(x['K·∫øt lu·∫≠n']||x['conclusion']||''),
              reportUrl: String(x['Link BCpdf']||x['Li√™n k·∫øt b√°o c√°o']||x['reportUrl']||'')
            };
          });
          FILTERED = applyFilters(ALL_ITEMS);
          CURRENT_PAGE=1; renderTable();
          showToast('ƒê√£ n·∫°p JSON th·ªß c√¥ng.','success');
        }catch(_){ showToast('N·∫°p JSON th·∫•t b·∫°i.','error'); }
      });
      document.getElementById('btn-reset')?.addEventListener('click', async (e)=>{
        e.preventDefault(); 
        ['flt-q','flt-status','flt-from','flt-to'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if (el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }); 
        SELECTED_GROUP = 'all';
        document.querySelectorAll('.group-btn').forEach(b=> b.classList.remove('active'));
        document.getElementById('btn-group-all')?.classList.add('active');
        await reload();
      });

      // Tab switching logic
      const tabs = document.querySelectorAll('.tab-btn');
      function showSection(id){
        ['form-approve','form-pdform'].forEach(secId=>{ 
          const s=document.getElementById(secId); 
          if(!s) return; 
          s.style.display = (secId===id)?'block':'none'; 
        });
        // Update active state
        tabs.forEach(t=> t.classList.remove('active'));
        const activeTab = document.querySelector(`.tab-btn[data-target="${id}"]`);
        if (activeTab) activeTab.classList.add('active');
        // Load data when switching to pdform section
        if (id === 'form-pdform' && PDFORM_ITEMS.length === 0) {
          reloadPdForm();
        }
      }
      tabs.forEach(b=> b.addEventListener('click', (e)=>{ 
        e.preventDefault(); 
        const id=b.getAttribute('data-target'); 
        if(id) showSection(id); 
      }));
      document.getElementById('flt-mode')?.addEventListener('change', (e)=>{ applyQuickRangeLocal(e.target.value||'All'); });
      // L·ªçc th·ªùi gian t·∫°i ch·ªó khi thay ƒë·ªïi ng√†y From/To
      document.getElementById('flt-from')?.addEventListener('change', ()=>{ filterTimeInPlace(); });
      document.getElementById('flt-to')?.addEventListener('change', ()=>{ filterTimeInPlace(); });
      document.getElementById('page-size')?.addEventListener('change', (e)=>{ PAGE_SIZE = Number(e.target.value||20)||20; CURRENT_PAGE=1; renderTable(); });
      document.getElementById('prev')?.addEventListener('click', ()=>{ if (CURRENT_PAGE>1){ CURRENT_PAGE--; renderTable(); } });
      document.getElementById('next')?.addEventListener('click', ()=>{ const pages=Math.max(1,Math.ceil(FILTERED.length/PAGE_SIZE)); if (CURRENT_PAGE<pages){ CURRENT_PAGE++; renderTable(); } });

      // First load: set default date range from first day of current month to last day
      try{
        const fromEl=document.getElementById('flt-from');
        const toEl=document.getElementById('flt-to');
        const now=new Date();
        const start=new Date(now.getFullYear(), now.getMonth(), 1);
        const end=new Date(now.getFullYear(), now.getMonth()+1, 0);
        const toISO=(x)=>`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;
        if(fromEl) fromEl.value = toISO(start);
        if(toEl) toEl.value = toISO(end);
        // Default status: Tr∆∞·ªüng nh√≥m Review (Pending2)
        const stSel=document.getElementById('flt-status'); if (stSel){ stSel.value = 'Pending2'; }
      }catch(_){ }
      // Show default section
      showSection('form-approve');
      reload();
    })();

    async function reload(){
      const btn = document.getElementById('btn-search'); const prev = btn?btn.textContent:''; if(btn){ btn.disabled=true; btn.innerHTML = "<span class='spinner mr-2'></span>ƒêang t·∫£i..."; }
      try{
        const params = {
          q: document.getElementById('flt-q')?.value||'',
          status: document.getElementById('flt-status')?.value||'',
          from: document.getElementById('flt-from')?.value||'',
          to: document.getElementById('flt-to')?.value||'',
          mode: document.getElementById('flt-mode')?.value||'All',
          page: CURRENT_PAGE,
          pageSize: PAGE_SIZE
        };
        const items = await fetchReports(params);
        ALL_ITEMS = Array.isArray(items) ? items : [];
        FILTERED = applyFilters(ALL_ITEMS);
        CURRENT_PAGE = 1;
        renderTable();
      }catch(err){
        showToast('L·ªói t·∫£i d·ªØ li·ªáu.','error');
      }finally{ if(btn){ btn.disabled=false; btn.textContent = prev||'Tra c·ª©u'; } }
    }

    function applyQuickRange(mode){
      const fromEl = document.getElementById('flt-from'); const toEl = document.getElementById('flt-to'); if(!fromEl||!toEl) return;
      const d = new Date();
      function toISO(x){ const yy=x.getFullYear(); const mm=String(x.getMonth()+1).padStart(2,'0'); const dd=String(x.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
      if (mode==='All'){ fromEl.value=''; toEl.value=''; reload(); return; }
      if (mode==='Day'){ const s=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const e=new Date(d.getFullYear(), d.getMonth(), d.getDate()); fromEl.value=toISO(s); toEl.value=toISO(e); reload(); return; }
      if (mode==='Week'){ const day=d.getDay()||7; const s=new Date(d); s.setDate(d.getDate() - (day-1)); const e=new Date(s); e.setDate(s.getDate()+6); fromEl.value=toISO(s); toEl.value=toISO(e); reload(); return; }
      if (mode==='Month'){ const s=new Date(d.getFullYear(), d.getMonth(), 1); const e=new Date(d.getFullYear(), d.getMonth()+1, 0); fromEl.value=toISO(s); toEl.value=toISO(e); reload(); return; }
    }

    // L·ªçc th·ªùi gian t·∫°i ch·ªó (kh√¥ng g·ªçi API)
    function filterTimeInPlace(){
      try{ FILTERED = applyFilters(ALL_ITEMS); CURRENT_PAGE=1; renderTable(); }catch(_){ }
    }

    // Thi·∫øt l·∫≠p nhanh kho·∫£ng th·ªùi gian v√† l·ªçc t·∫°i ch·ªó
    function applyQuickRangeLocal(mode){
      const fromEl = document.getElementById('flt-from'); const toEl = document.getElementById('flt-to'); if(!fromEl||!toEl) return;
      const d = new Date();
      function toISO(x){ const yy=x.getFullYear(); const mm=String(x.getMonth()+1).padStart(2,'0'); const dd=String(x.getDate()).padStart(2,'0'); return `${yy}-${mm}-${dd}`; }
      if (mode==='All'){ fromEl.value=''; toEl.value=''; filterTimeInPlace(); return; }
      if (mode==='Day'){ const s=new Date(d.getFullYear(), d.getMonth(), d.getDate()); const e=new Date(d.getFullYear(), d.getMonth(), d.getDate()); fromEl.value=toISO(s); toEl.value=toISO(e); filterTimeInPlace(); return; }
      if (mode==='Week'){ const day=d.getDay()||7; const s=new Date(d); s.setDate(d.getDate() - (day-1)); const e=new Date(s); e.setDate(s.getDate()+6); fromEl.value=toISO(s); toEl.value=toISO(e); filterTimeInPlace(); return; }
      if (mode==='Month'){ const s=new Date(d.getFullYear(), d.getMonth(), 1); const e=new Date(d.getFullYear(), d.getMonth()+1, 0); fromEl.value=toISO(s); toEl.value=toISO(e); filterTimeInPlace(); return; }
    }
  </script>
</body>
</html>

